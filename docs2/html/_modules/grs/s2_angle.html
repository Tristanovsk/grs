
<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
    <title>grs.s2_angle &#8212; grs 1 documentation</title>
    <link rel="stylesheet" href="../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../_static/language_data.js"></script>
    <script async="async" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for grs.s2_angle</h1><div class="highlight"><pre>
<span></span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">Optional code to compute viewing configuration for S2</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">xml.etree.ElementTree</span> <span class="k">as</span> <span class="nn">ET</span>
<span class="kn">from</span> <span class="nn">math</span> <span class="k">import</span> <span class="n">sqrt</span><span class="p">,</span> <span class="n">cos</span><span class="p">,</span> <span class="n">sin</span><span class="p">,</span> <span class="n">tan</span><span class="p">,</span> <span class="n">pi</span><span class="p">,</span> <span class="n">asin</span><span class="p">,</span> <span class="n">acos</span><span class="p">,</span> <span class="n">atan</span><span class="p">,</span> <span class="n">atan2</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">osgeo</span> <span class="k">import</span> <span class="n">gdal</span>


<div class="viewcode-block" id="s2angle"><a class="viewcode-back" href="../../_autosummary/grs.s2_angle.html#grs.s2_angle.s2angle">[docs]</a><span class="k">class</span> <span class="nc">s2angle</span><span class="p">:</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Calculations of the viewing geometries for each pixel and band</span>
<span class="sd">    [kept for records; those calculations are now done through the ESA snappy library]</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="c1">############################################################################</span>
    <span class="c1"># Sudipta&#39;s addition to enable spatial subset</span>
    <span class="c1">############################################################################</span>

    <span class="n">K0</span> <span class="o">=</span> <span class="mf">0.9996</span>

    <span class="n">E</span> <span class="o">=</span> <span class="mf">0.00669438</span>
    <span class="n">E2</span> <span class="o">=</span> <span class="n">E</span> <span class="o">*</span> <span class="n">E</span>
    <span class="n">E3</span> <span class="o">=</span> <span class="n">E2</span> <span class="o">*</span> <span class="n">E</span>
    <span class="n">E_P2</span> <span class="o">=</span> <span class="n">E</span> <span class="o">/</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">E</span><span class="p">)</span>

    <span class="n">SQRT_E</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">E</span><span class="p">)</span>
    <span class="n">_E</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">SQRT_E</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">SQRT_E</span><span class="p">)</span>
    <span class="n">_E2</span> <span class="o">=</span> <span class="n">_E</span> <span class="o">*</span> <span class="n">_E</span>
    <span class="n">_E3</span> <span class="o">=</span> <span class="n">_E2</span> <span class="o">*</span> <span class="n">_E</span>
    <span class="n">_E4</span> <span class="o">=</span> <span class="n">_E3</span> <span class="o">*</span> <span class="n">_E</span>
    <span class="n">_E5</span> <span class="o">=</span> <span class="n">_E4</span> <span class="o">*</span> <span class="n">_E</span>

    <span class="n">M1</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">E</span> <span class="o">/</span> <span class="mi">4</span> <span class="o">-</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">E2</span> <span class="o">/</span> <span class="mi">64</span> <span class="o">-</span> <span class="mi">5</span> <span class="o">*</span> <span class="n">E3</span> <span class="o">/</span> <span class="mi">256</span><span class="p">)</span>
    <span class="n">M2</span> <span class="o">=</span> <span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="n">E</span> <span class="o">/</span> <span class="mi">8</span> <span class="o">+</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">E2</span> <span class="o">/</span> <span class="mi">32</span> <span class="o">+</span> <span class="mi">45</span> <span class="o">*</span> <span class="n">E3</span> <span class="o">/</span> <span class="mi">1024</span><span class="p">)</span>
    <span class="n">M3</span> <span class="o">=</span> <span class="p">(</span><span class="mi">15</span> <span class="o">*</span> <span class="n">E2</span> <span class="o">/</span> <span class="mi">256</span> <span class="o">+</span> <span class="mi">45</span> <span class="o">*</span> <span class="n">E3</span> <span class="o">/</span> <span class="mi">1024</span><span class="p">)</span>
    <span class="n">M4</span> <span class="o">=</span> <span class="p">(</span><span class="mi">35</span> <span class="o">*</span> <span class="n">E3</span> <span class="o">/</span> <span class="mi">3072</span><span class="p">)</span>

    <span class="n">P2</span> <span class="o">=</span> <span class="p">(</span><span class="mf">3.</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">_E</span> <span class="o">-</span> <span class="mf">27.</span> <span class="o">/</span> <span class="mi">32</span> <span class="o">*</span> <span class="n">_E3</span> <span class="o">+</span> <span class="mf">269.</span> <span class="o">/</span> <span class="mi">512</span> <span class="o">*</span> <span class="n">_E5</span><span class="p">)</span>
    <span class="n">P3</span> <span class="o">=</span> <span class="p">(</span><span class="mf">21.</span> <span class="o">/</span> <span class="mi">16</span> <span class="o">*</span> <span class="n">_E2</span> <span class="o">-</span> <span class="mf">55.</span> <span class="o">/</span> <span class="mi">32</span> <span class="o">*</span> <span class="n">_E4</span><span class="p">)</span>
    <span class="n">P4</span> <span class="o">=</span> <span class="p">(</span><span class="mf">151.</span> <span class="o">/</span> <span class="mi">96</span> <span class="o">*</span> <span class="n">_E3</span> <span class="o">-</span> <span class="mf">417.</span> <span class="o">/</span> <span class="mi">128</span> <span class="o">*</span> <span class="n">_E5</span><span class="p">)</span>
    <span class="n">P5</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1097.</span> <span class="o">/</span> <span class="mi">512</span> <span class="o">*</span> <span class="n">_E4</span><span class="p">)</span>

    <span class="n">R</span> <span class="o">=</span> <span class="mi">6378137</span>

    <span class="n">ZONE_LETTERS</span> <span class="o">=</span> <span class="s2">&quot;CDEFGHJKLMNPQRSTUVWXX&quot;</span>
    <span class="c1"># Define constants</span>
    <span class="n">a</span> <span class="o">=</span> <span class="mf">6378137.0</span>  <span class="c1"># WGS 84 semi-major axis in meters</span>
    <span class="n">b</span> <span class="o">=</span> <span class="mf">6356752.314</span>  <span class="c1"># WGS 84 semi-minor axis in meters</span>
    <span class="n">ecc</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">-</span> <span class="n">b</span> <span class="o">/</span> <span class="n">a</span> <span class="o">*</span> <span class="n">b</span> <span class="o">/</span> <span class="n">a</span>  <span class="c1"># WGS 84 ellipsoid eccentricity</span>
    <span class="n">todeg</span> <span class="o">=</span> <span class="mf">180.0</span> <span class="o">/</span> <span class="n">pi</span>  <span class="c1"># Converts radians to degrees</span>

    <span class="k">def</span> <span class="nf">angle_writer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">XML_File</span><span class="p">):</span>
        <span class="c1"># Capture the input and output file names</span>
        <span class="n">odir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">XML_File</span><span class="p">))</span>
        <span class="n">odir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">odir</span><span class="p">,</span> <span class="s1">&#39;ANG_DATA&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">odir</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">odir</span><span class="p">)</span>

        <span class="c1"># Set the output angle file GSD</span>
        <span class="n">gsd</span> <span class="o">=</span> <span class="p">[</span><span class="mi">60</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">60</span><span class="p">,</span> <span class="mi">60</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">20</span><span class="p">]</span>
        <span class="n">subsamp</span> <span class="o">=</span> <span class="mi">5</span>
        <span class="c1"># if len(sys.argv) &gt; 2:</span>
        <span class="c1">#     subsamp = int(sys.argv[2]);</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Using subsampling factor of </span><span class="si">%d</span><span class="s1">.&#39;</span> <span class="o">%</span> <span class="n">subsamp</span><span class="p">)</span>

        <span class="c1"># Sudipta spatial subset setting</span>
        <span class="n">sul_lat</span> <span class="o">=</span> <span class="n">sul_lon</span> <span class="o">=</span> <span class="n">slr_lat</span> <span class="o">=</span> <span class="n">slr_lon</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># if len(sys.argv) &gt; 3:  # expect spatial subset bbox coords as &lt;ullat,ullon,lrlat,lrlon&gt;</span>
        <span class="c1">#     sul_lat, sul_lon, slr_lat, slr_lon = [float(x) for x in sys.argv[3].split(&#39;,&#39;)]</span>
        <span class="c1">#     print &quot;sul_lat,sul_lon,slr_lat,slr_lon = {},{},{},{}&quot;.format(sul_lat, sul_lon, slr_lat, slr_lon)</span>

        <span class="c1"># sul_lat = 45.50</span>
        <span class="c1"># slr_lat = 45.10</span>
        <span class="c1"># sul_lon = 12.75</span>
        <span class="c1"># slr_lon = 13.14</span>

        <span class="c1"># Load the angle observations from the metadata</span>
        <span class="p">(</span><span class="n">Tile_ID</span><span class="p">,</span> <span class="n">AngleObs</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_angleobs</span><span class="p">(</span><span class="n">XML_File</span><span class="p">)</span>
        <span class="n">Tile_Base</span> <span class="o">=</span> <span class="n">Tile_ID</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Loaded view angles from metadata for tile: &#39;</span><span class="p">,</span> <span class="n">Tile_ID</span><span class="p">)</span>

        <span class="c1"># Reconstruct the Orbit from the Angles</span>
        <span class="p">(</span><span class="n">Orbit</span><span class="p">,</span> <span class="n">TimeParms</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Fit_Orbit</span><span class="p">(</span><span class="n">AngleObs</span><span class="p">)</span>
        <span class="n">Omega0</span> <span class="o">=</span> <span class="n">asin</span><span class="p">(</span><span class="n">sin</span><span class="p">(</span><span class="n">Orbit</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="n">sin</span><span class="p">(</span><span class="n">Orbit</span><span class="p">[</span><span class="mi">3</span><span class="p">]))</span>
        <span class="n">Orbit</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Omega0</span><span class="p">)</span>
        <span class="n">Lon0</span> <span class="o">=</span> <span class="n">Orbit</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">asin</span><span class="p">(</span><span class="n">tan</span><span class="p">(</span><span class="n">Orbit</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="o">-</span><span class="n">tan</span><span class="p">(</span><span class="n">Orbit</span><span class="p">[</span><span class="mi">3</span><span class="p">]))</span>
        <span class="n">Orbit</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Lon0</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Orbit processing complete&#39;</span><span class="p">)</span>

        <span class="c1"># Load the detector footprints</span>
        <span class="n">BandFoot</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_detfootprint</span><span class="p">(</span><span class="n">XML_File</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Loaded detector footprints from QI files&#39;</span><span class="p">)</span>
        <span class="c1"># harmel adjust for python3</span>
        <span class="c1"># --&gt; replace div / by integer div //</span>
        <span class="c1"># Loop through the bands using TimeParms which are in band order</span>
        <span class="k">for</span> <span class="n">tparms</span> <span class="ow">in</span> <span class="n">TimeParms</span><span class="p">:</span>
            <span class="n">band</span> <span class="o">=</span> <span class="n">tparms</span><span class="p">[</span><span class="s1">&#39;band&#39;</span><span class="p">]</span>
            <span class="n">coeffs</span> <span class="o">=</span> <span class="n">tparms</span><span class="p">[</span><span class="s1">&#39;tmodel&#39;</span><span class="p">]</span>
            <span class="c1"># Set up the output array</span>
            <span class="n">out_rows</span> <span class="o">=</span> <span class="n">AngleObs</span><span class="p">[</span><span class="s1">&#39;nrows&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">//</span> <span class="n">gsd</span><span class="p">[</span><span class="n">band</span><span class="p">]</span> <span class="o">//</span> <span class="n">subsamp</span>
            <span class="n">out_cols</span> <span class="o">=</span> <span class="n">AngleObs</span><span class="p">[</span><span class="s1">&#39;ncols&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">//</span> <span class="n">gsd</span><span class="p">[</span><span class="n">band</span><span class="p">]</span> <span class="o">//</span> <span class="n">subsamp</span>
            <span class="k">if</span> <span class="n">subsamp</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">out_rows</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">out_cols</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="c1">#######################################################</span>
            <span class="c1">## Sudipta addition to support spatial subset</span>
            <span class="c1">######################################################</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">sul_lat</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
                <span class="c1"># Convert the spatial subset bbox lat, lon to UTM coords.</span>
                <span class="n">ul_sx</span><span class="p">,</span> <span class="n">ul_sy</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">from_latlon</span><span class="p">(</span><span class="n">sul_lat</span><span class="p">,</span> <span class="n">sul_lon</span><span class="p">)</span>
                <span class="n">lr_sx</span><span class="p">,</span> <span class="n">lr_sy</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">from_latlon</span><span class="p">(</span><span class="n">slr_lat</span><span class="p">,</span> <span class="n">slr_lon</span><span class="p">)</span>

                <span class="c1"># now calculate the bbox row, col pairs</span>
                <span class="n">ulx</span> <span class="o">=</span> <span class="n">AngleObs</span><span class="p">[</span><span class="s1">&#39;ul_x&#39;</span><span class="p">]</span>
                <span class="n">uly</span> <span class="o">=</span> <span class="n">AngleObs</span><span class="p">[</span><span class="s1">&#39;ul_y&#39;</span><span class="p">]</span>
                <span class="n">ul_s_c</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">int</span><span class="p">((</span><span class="n">ul_sx</span> <span class="o">-</span> <span class="n">ulx</span><span class="p">)</span> <span class="o">//</span> <span class="n">gsd</span><span class="p">[</span><span class="n">band</span><span class="p">]</span> <span class="o">//</span> <span class="n">subsamp</span><span class="p">))</span>
                <span class="n">ul_s_r</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">int</span><span class="p">((</span><span class="n">uly</span> <span class="o">-</span> <span class="n">ul_sy</span><span class="p">)</span> <span class="o">//</span> <span class="n">gsd</span><span class="p">[</span><span class="n">band</span><span class="p">]</span> <span class="o">//</span> <span class="n">subsamp</span><span class="p">))</span>
                <span class="n">lr_s_c</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">out_cols</span><span class="p">,</span> <span class="nb">int</span><span class="p">((</span><span class="n">lr_sx</span> <span class="o">-</span> <span class="n">ulx</span><span class="p">)</span> <span class="o">//</span> <span class="n">gsd</span><span class="p">[</span><span class="n">band</span><span class="p">]</span> <span class="o">//</span> <span class="n">subsamp</span><span class="p">))</span>
                <span class="n">lr_s_r</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">out_rows</span><span class="p">,</span> <span class="nb">int</span><span class="p">((</span><span class="n">uly</span> <span class="o">-</span> <span class="n">lr_sy</span><span class="p">)</span> <span class="o">//</span> <span class="n">gsd</span><span class="p">[</span><span class="n">band</span><span class="p">]</span> <span class="o">//</span> <span class="n">subsamp</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ul_s_r</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">ul_s_c</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">lr_s_r</span> <span class="o">=</span> <span class="n">out_rows</span>
                <span class="n">lr_s_c</span> <span class="o">=</span> <span class="n">out_cols</span>

            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;ul_s_r = </span><span class="si">{}</span><span class="s2">, ul_s_c = </span><span class="si">{}</span><span class="s2">, lr_s_r = </span><span class="si">{}</span><span class="s2">, lr_s_c = </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ul_s_r</span><span class="p">,</span> <span class="n">ul_s_c</span><span class="p">,</span> <span class="n">lr_s_r</span><span class="p">,</span> <span class="n">lr_s_c</span><span class="p">))</span>

            <span class="c1"># sys.exit(0)</span>
            <span class="c1">#######################################################</span>
            <span class="c1">## Sudipta addition to support spatial subset</span>
            <span class="c1">######################################################</span>

            <span class="c1"># GVecs = CalcGroundVectors( AngleObs, gsd[band], subsamp, out_rows, out_cols)</span>
            <span class="c1"># sudipta changed above to support spatial subset</span>

            <span class="n">GVecs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">CalcGroundVectors</span><span class="p">(</span><span class="n">AngleObs</span><span class="p">,</span> <span class="n">gsd</span><span class="p">[</span><span class="n">band</span><span class="p">],</span> <span class="n">subsamp</span><span class="p">,</span> <span class="n">ul_s_r</span><span class="p">,</span> <span class="n">lr_s_r</span><span class="p">,</span> <span class="n">ul_s_c</span><span class="p">,</span> <span class="n">lr_s_c</span><span class="p">,</span> <span class="n">out_rows</span><span class="p">,</span>
                                           <span class="n">out_cols</span><span class="p">)</span>
            <span class="n">zenith</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">out_rows</span><span class="p">,</span> <span class="n">out_cols</span><span class="p">))</span>
            <span class="n">azimuth</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">out_rows</span><span class="p">,</span> <span class="n">out_cols</span><span class="p">))</span>
            <span class="c1">#harmel nodata value</span>
            <span class="c1"># zenith.fill(np.nan)</span>
            <span class="c1"># azimuth.fill(np.nan)</span>

            <span class="n">detcount</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">matrix</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">out_rows</span><span class="p">,</span> <span class="n">out_cols</span><span class="p">)))</span>
            <span class="c1"># Find the detector footprints for this band</span>
            <span class="k">for</span> <span class="n">foot</span> <span class="ow">in</span> <span class="n">BandFoot</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">foot</span><span class="p">[</span><span class="s1">&#39;bandId&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">band</span><span class="p">:</span>
                    <span class="n">detId</span> <span class="o">=</span> <span class="n">foot</span><span class="p">[</span><span class="s1">&#39;detId&#39;</span><span class="p">]</span>
                    <span class="n">bandName</span> <span class="o">=</span> <span class="n">foot</span><span class="p">[</span><span class="s1">&#39;bandName&#39;</span><span class="p">]</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Scanning band &#39;</span><span class="p">,</span> <span class="n">band</span><span class="p">,</span> <span class="s1">&#39; detector &#39;</span><span class="p">,</span> <span class="n">detId</span><span class="p">)</span>
                    <span class="n">minloc</span> <span class="o">=</span> <span class="p">[</span><span class="n">foot</span><span class="p">[</span><span class="s1">&#39;coords&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">foot</span><span class="p">[</span><span class="s1">&#39;coords&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]]</span>
                    <span class="n">maxloc</span> <span class="o">=</span> <span class="p">[</span><span class="n">foot</span><span class="p">[</span><span class="s1">&#39;coords&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">foot</span><span class="p">[</span><span class="s1">&#39;coords&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]]</span>
                    <span class="k">for</span> <span class="n">pointloc</span> <span class="ow">in</span> <span class="n">foot</span><span class="p">[</span><span class="s1">&#39;coords&#39;</span><span class="p">]:</span>
                        <span class="k">if</span> <span class="n">pointloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">minloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                            <span class="n">minloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">pointloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="k">if</span> <span class="n">pointloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">maxloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                            <span class="n">maxloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">pointloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="k">if</span> <span class="n">pointloc</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">minloc</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                            <span class="n">minloc</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">pointloc</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                        <span class="k">if</span> <span class="n">pointloc</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">maxloc</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                            <span class="n">maxloc</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">pointloc</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">segs</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">foot</span><span class="p">[</span><span class="s1">&#39;coords&#39;</span><span class="p">])</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
                        <span class="n">point0</span> <span class="o">=</span> <span class="n">foot</span><span class="p">[</span><span class="s1">&#39;coords&#39;</span><span class="p">][</span><span class="n">index</span><span class="p">]</span>
                        <span class="n">point1</span> <span class="o">=</span> <span class="n">foot</span><span class="p">[</span><span class="s1">&#39;coords&#39;</span><span class="p">][</span><span class="n">index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
                        <span class="k">if</span> <span class="n">point1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">point0</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                            <span class="n">slope</span> <span class="o">=</span> <span class="mf">0.0</span>
                            <span class="n">intercept</span> <span class="o">=</span> <span class="n">point0</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">slope</span> <span class="o">=</span> <span class="p">(</span><span class="n">point1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">point0</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span><span class="n">point1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">point0</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                            <span class="n">intercept</span> <span class="o">=</span> <span class="n">point0</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">slope</span> <span class="o">*</span> <span class="n">point0</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                        <span class="k">if</span> <span class="n">point1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">point0</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                            <span class="n">ymin</span> <span class="o">=</span> <span class="n">point1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                            <span class="n">ymax</span> <span class="o">=</span> <span class="n">point0</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">ymin</span> <span class="o">=</span> <span class="n">point0</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                            <span class="n">ymax</span> <span class="o">=</span> <span class="n">point1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                        <span class="n">segs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                            <span class="p">{</span><span class="s1">&#39;y0&#39;</span><span class="p">:</span> <span class="n">point0</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;ymin&#39;</span><span class="p">:</span> <span class="n">ymin</span><span class="p">,</span> <span class="s1">&#39;ymax&#39;</span><span class="p">:</span> <span class="n">ymax</span><span class="p">,</span> <span class="s1">&#39;slope&#39;</span><span class="p">:</span> <span class="n">slope</span><span class="p">,</span> <span class="s1">&#39;intercept&#39;</span><span class="p">:</span> <span class="n">intercept</span><span class="p">})</span>
                    <span class="c1"># Scan the array</span>
                    <span class="c1"># for row in range( out_rows ):</span>
                    <span class="c1"># sudipta changed above to support spatial subset</span>
                    <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ul_s_r</span><span class="p">,</span> <span class="n">lr_s_r</span><span class="p">):</span>
                        <span class="n">dy</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">row</span> <span class="o">*</span> <span class="n">gsd</span><span class="p">[</span><span class="n">band</span><span class="p">]</span> <span class="o">*</span> <span class="n">subsamp</span><span class="p">)</span>
                        <span class="n">y</span> <span class="o">=</span> <span class="n">AngleObs</span><span class="p">[</span><span class="s1">&#39;ul_y&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">dy</span> <span class="o">-</span> <span class="n">gsd</span><span class="p">[</span><span class="n">band</span><span class="p">]</span> <span class="o">/</span> <span class="mf">2.0</span>
                        <span class="k">if</span> <span class="n">y</span> <span class="o">&lt;</span> <span class="n">minloc</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">or</span> <span class="n">y</span> <span class="o">&gt;</span> <span class="n">maxloc</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                            <span class="k">continue</span>
                        <span class="n">xlist</span> <span class="o">=</span> <span class="p">[]</span>
                        <span class="k">for</span> <span class="n">seg</span> <span class="ow">in</span> <span class="n">segs</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">y</span> <span class="o">==</span> <span class="n">seg</span><span class="p">[</span><span class="s1">&#39;y0&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="p">(</span><span class="n">y</span> <span class="o">&gt;</span> <span class="n">seg</span><span class="p">[</span><span class="s1">&#39;ymin&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">y</span> <span class="o">&lt;</span> <span class="n">seg</span><span class="p">[</span><span class="s1">&#39;ymax&#39;</span><span class="p">]):</span>
                                <span class="n">x</span> <span class="o">=</span> <span class="n">seg</span><span class="p">[</span><span class="s1">&#39;intercept&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">y</span> <span class="o">*</span> <span class="n">seg</span><span class="p">[</span><span class="s1">&#39;slope&#39;</span><span class="p">]</span>
                                <span class="n">xlist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
                        <span class="n">xlist</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">xlist</span><span class="p">)</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Invalid footprint intersection&#39;</span><span class="p">)</span>
                            <span class="k">break</span>
                        <span class="c1"># for col in range( out_cols ):</span>
                        <span class="c1"># sudipta changed above to support spatial subset</span>
                        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ul_s_c</span><span class="p">,</span> <span class="n">lr_s_c</span><span class="p">):</span>
                            <span class="n">dx</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">col</span> <span class="o">*</span> <span class="n">gsd</span><span class="p">[</span><span class="n">band</span><span class="p">]</span> <span class="o">*</span> <span class="n">subsamp</span><span class="p">)</span>
                            <span class="n">x</span> <span class="o">=</span> <span class="n">AngleObs</span><span class="p">[</span><span class="s1">&#39;ul_x&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">dx</span> <span class="o">+</span> <span class="n">gsd</span><span class="p">[</span><span class="n">band</span><span class="p">]</span> <span class="o">/</span> <span class="mf">2.0</span>
                            <span class="k">if</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="n">minloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">or</span> <span class="n">x</span> <span class="o">&gt;</span> <span class="n">maxloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                                <span class="k">continue</span>
                            <span class="c1"># See if this point is inside the footprint</span>
                            <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span>
                            <span class="k">while</span> <span class="n">index</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">xlist</span><span class="p">):</span>
                                <span class="k">if</span> <span class="n">x</span> <span class="o">&gt;=</span> <span class="n">xlist</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="ow">and</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="n">xlist</span><span class="p">[</span><span class="n">index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]:</span>
                                    <span class="c1"># It is</span>
                                    <span class="n">calctime</span> <span class="o">=</span> <span class="n">coeffs</span><span class="p">[</span><span class="n">detId</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">coeffs</span><span class="p">[</span><span class="n">detId</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">dx</span> <span class="o">+</span> <span class="n">coeffs</span><span class="p">[</span><span class="n">detId</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="n">dy</span> <span class="o">+</span> \
                                               <span class="n">coeffs</span><span class="p">[</span><span class="n">detId</span><span class="p">][</span>
                                                   <span class="mi">3</span><span class="p">]</span> <span class="o">*</span> <span class="n">dx</span> <span class="o">*</span> <span class="n">dy</span>
                                    <span class="n">detcount</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                                    <span class="n">Px</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">CalcOrbit</span><span class="p">(</span><span class="n">calctime</span><span class="p">,</span> <span class="n">Orbit</span><span class="p">)</span>
                                    <span class="n">Gx</span> <span class="o">=</span> <span class="p">[</span><span class="n">GVecs</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">GVecs</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">GVecs</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">,</span> <span class="mi">2</span><span class="p">]]</span>
                                    <span class="n">Vx</span> <span class="o">=</span> <span class="p">[</span><span class="n">Px</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">Gx</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">Px</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">Gx</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">Px</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">Gx</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span>
                                    <span class="n">Vlen</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Magnitude</span><span class="p">(</span><span class="n">Vx</span><span class="p">)</span>
                                    <span class="n">Vx</span> <span class="o">=</span> <span class="p">[</span><span class="n">Vx</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="n">Vlen</span><span class="p">,</span> <span class="n">Vx</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">Vlen</span><span class="p">,</span> <span class="n">Vx</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">/</span> <span class="n">Vlen</span><span class="p">]</span>
                                    <span class="n">LSRz</span> <span class="o">=</span> <span class="p">[</span><span class="n">Gx</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">a</span><span class="p">,</span> <span class="n">Gx</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">a</span><span class="p">,</span> <span class="n">Gx</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">b</span><span class="p">]</span>
                                    <span class="n">Vlen</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">LSRz</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">LSRz</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">LSRz</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">LSRz</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                                    <span class="n">LSRx</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="n">LSRz</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">Vlen</span><span class="p">,</span> <span class="n">LSRz</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="n">Vlen</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">]</span>
                                    <span class="n">LSRy</span> <span class="o">=</span> <span class="p">[</span><span class="n">LSRz</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">LSRx</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">LSRz</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="n">LSRx</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                                            <span class="n">LSRz</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="n">LSRx</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">LSRz</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">LSRx</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
                                            <span class="n">LSRz</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">LSRx</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">LSRz</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">LSRx</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
                                    <span class="n">LSRVec</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">Dot</span><span class="p">(</span><span class="n">Vx</span><span class="p">,</span> <span class="n">LSRx</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">Dot</span><span class="p">(</span><span class="n">Vx</span><span class="p">,</span> <span class="n">LSRy</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">Dot</span><span class="p">(</span><span class="n">Vx</span><span class="p">,</span> <span class="n">LSRz</span><span class="p">)]</span>
                                    <span class="n">zenith</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">]</span> <span class="o">+=</span> <span class="nb">round</span><span class="p">(</span><span class="n">acos</span><span class="p">(</span><span class="n">LSRVec</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">todeg</span> <span class="o">*</span> <span class="mf">100.0</span><span class="p">)</span>
                                    <span class="n">azimuth</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">]</span> <span class="o">+=</span> <span class="nb">round</span><span class="p">(</span><span class="n">atan2</span><span class="p">(</span><span class="n">LSRVec</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">LSRVec</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">todeg</span> <span class="o">*</span> <span class="mf">100.0</span><span class="p">)</span>
                                    <span class="k">if</span> <span class="n">detcount</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                                        <span class="n">zenith</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">]</span> <span class="o">/=</span> <span class="n">detcount</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">]</span>
                                        <span class="n">azimuth</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">]</span> <span class="o">/=</span> <span class="n">detcount</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">]</span>
                                    <span class="n">index</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">xlist</span><span class="p">)</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="n">index</span> <span class="o">+=</span> <span class="mi">2</span>

            <span class="c1"># print &quot;row = {}, col = {}, zenith = {}&quot;.format(1000, 450, zenith[1000, 450])</span>
            <span class="c1"># Write out the angles</span>
            <span class="n">Out_File</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">odir</span><span class="p">,</span> <span class="n">Tile_Base</span><span class="p">[</span><span class="mi">0</span><span class="p">][:</span><span class="o">-</span><span class="mi">4</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;_ang_&#39;</span> <span class="o">+</span> <span class="n">bandName</span> <span class="o">+</span> <span class="s1">&#39;.img&#39;</span><span class="p">)</span>
            <span class="c1"># hfile = open( Out_File, &#39;wb&#39; )</span>
            <span class="c1"># for ang in np.nditer( azimuth, order=&#39;C&#39;):</span>
            <span class="c1">#	hfile.write( struct.pack(&#39;h&#39;,ang) )</span>
            <span class="c1"># for ang in np.nditer( zenith, order=&#39;C&#39;):</span>
            <span class="c1">#	hfile.write( struct.pack(&#39;h&#39;,ang) )</span>
            <span class="c1"># hfile.close()</span>
            <span class="c1"># Sudiptas addition</span>
            <span class="n">driver</span> <span class="o">=</span> <span class="n">gdal</span><span class="o">.</span><span class="n">GetDriverByName</span><span class="p">(</span><span class="s2">&quot;ENVI&quot;</span><span class="p">)</span>
            <span class="n">hfile</span> <span class="o">=</span> <span class="n">driver</span><span class="o">.</span><span class="n">Create</span><span class="p">(</span><span class="n">Out_File</span><span class="p">,</span> <span class="n">out_rows</span><span class="p">,</span> <span class="n">out_cols</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">gdal</span><span class="o">.</span><span class="n">GDT_Int16</span><span class="p">)</span>
            <span class="n">hfile</span><span class="o">.</span><span class="n">GetRasterBand</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">WriteArray</span><span class="p">(</span><span class="n">azimuth</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">hfile</span><span class="o">.</span><span class="n">GetRasterBand</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">WriteArray</span><span class="p">(</span><span class="n">zenith</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="c1">#harmel set nodata value</span>
            <span class="n">hfile</span><span class="o">.</span><span class="n">GetRasterBand</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">SetNoDataValue</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">hfile</span><span class="o">.</span><span class="n">GetRasterBand</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">SetNoDataValue</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

            <span class="n">hfile</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="c1"># remove the default envi header file that gdal creates to replace</span>
            <span class="n">tmphdr</span> <span class="o">=</span> <span class="n">Out_File</span><span class="p">[:</span><span class="o">-</span><span class="mi">4</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;.hdr&#39;</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">tmphdr</span><span class="p">)</span>
            <span class="n">Hdr_File</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">WriteHeader</span><span class="p">(</span><span class="n">Out_File</span><span class="p">[:</span><span class="o">-</span><span class="mi">4</span><span class="p">],</span> <span class="n">out_rows</span><span class="p">,</span> <span class="n">out_cols</span><span class="p">,</span> <span class="n">AngleObs</span><span class="p">[</span><span class="s1">&#39;ul_x&#39;</span><span class="p">],</span> <span class="n">AngleObs</span><span class="p">[</span><span class="s1">&#39;ul_y&#39;</span><span class="p">],</span>
                                        <span class="n">gsd</span><span class="p">[</span><span class="n">band</span><span class="p">]</span> <span class="o">*</span> <span class="n">subsamp</span><span class="p">,</span>
                                        <span class="n">AngleObs</span><span class="p">[</span><span class="s1">&#39;zone&#39;</span><span class="p">],</span> <span class="n">AngleObs</span><span class="p">[</span><span class="s1">&#39;hemis&#39;</span><span class="p">])</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Created image file </span><span class="si">%s</span><span class="s1"> and header file </span><span class="si">%s</span><span class="s1">.&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">Out_File</span><span class="p">,</span> <span class="n">Hdr_File</span><span class="p">))</span>
            <span class="c1"># sys.exit(0)</span>

    <span class="k">def</span> <span class="nf">from_latlon</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">latitude</span><span class="p">,</span> <span class="n">longitude</span><span class="p">,</span> <span class="n">force_zone_number</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="o">-</span><span class="mf">80.0</span> <span class="o">&lt;=</span> <span class="n">latitude</span> <span class="o">&lt;=</span> <span class="mf">84.0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="bp">self</span><span class="o">.</span><span class="n">OutOfRangeError</span><span class="p">(</span><span class="s1">&#39;latitude out of range (must be between 80 deg S and 84 deg N)&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="o">-</span><span class="mf">180.0</span> <span class="o">&lt;=</span> <span class="n">longitude</span> <span class="o">&lt;=</span> <span class="mf">180.0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="bp">self</span><span class="o">.</span><span class="n">OutOfRangeError</span><span class="p">(</span><span class="s1">&#39;longitude out of range (must be between 180 deg W and 180 deg E)&#39;</span><span class="p">)</span>

        <span class="n">lat_rad</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">latitude</span><span class="p">)</span>
        <span class="n">lat_sin</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">lat_rad</span><span class="p">)</span>
        <span class="n">lat_cos</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">lat_rad</span><span class="p">)</span>

        <span class="n">lat_tan</span> <span class="o">=</span> <span class="n">lat_sin</span> <span class="o">/</span> <span class="n">lat_cos</span>
        <span class="n">lat_tan2</span> <span class="o">=</span> <span class="n">lat_tan</span> <span class="o">*</span> <span class="n">lat_tan</span>
        <span class="n">lat_tan4</span> <span class="o">=</span> <span class="n">lat_tan2</span> <span class="o">*</span> <span class="n">lat_tan2</span>

        <span class="k">if</span> <span class="n">force_zone_number</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">zone_number</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">latlon_to_zone_number</span><span class="p">(</span><span class="n">latitude</span><span class="p">,</span> <span class="n">longitude</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">zone_number</span> <span class="o">=</span> <span class="n">force_zone_number</span>

        <span class="n">zone_letter</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">latitude_to_zone_letter</span><span class="p">(</span><span class="n">latitude</span><span class="p">)</span>

        <span class="n">lon_rad</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">longitude</span><span class="p">)</span>
        <span class="n">central_lon</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">zone_number_to_central_longitude</span><span class="p">(</span><span class="n">zone_number</span><span class="p">)</span>
        <span class="n">central_lon_rad</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">central_lon</span><span class="p">)</span>

        <span class="n">n</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">R</span> <span class="o">/</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">E</span> <span class="o">*</span> <span class="n">lat_sin</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">E_P2</span> <span class="o">*</span> <span class="n">lat_cos</span> <span class="o">**</span> <span class="mi">2</span>

        <span class="n">a</span> <span class="o">=</span> <span class="n">lat_cos</span> <span class="o">*</span> <span class="p">(</span><span class="n">lon_rad</span> <span class="o">-</span> <span class="n">central_lon_rad</span><span class="p">)</span>
        <span class="n">a2</span> <span class="o">=</span> <span class="n">a</span> <span class="o">*</span> <span class="n">a</span>
        <span class="n">a3</span> <span class="o">=</span> <span class="n">a2</span> <span class="o">*</span> <span class="n">a</span>
        <span class="n">a4</span> <span class="o">=</span> <span class="n">a3</span> <span class="o">*</span> <span class="n">a</span>
        <span class="n">a5</span> <span class="o">=</span> <span class="n">a4</span> <span class="o">*</span> <span class="n">a</span>
        <span class="n">a6</span> <span class="o">=</span> <span class="n">a5</span> <span class="o">*</span> <span class="n">a</span>

        <span class="n">m</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">R</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">M1</span> <span class="o">*</span> <span class="n">lat_rad</span> <span class="o">-</span>
                      <span class="bp">self</span><span class="o">.</span><span class="n">M2</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">lat_rad</span><span class="p">)</span> <span class="o">+</span>
                      <span class="bp">self</span><span class="o">.</span><span class="n">M3</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="n">lat_rad</span><span class="p">)</span> <span class="o">-</span>
                      <span class="bp">self</span><span class="o">.</span><span class="n">M4</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="mi">6</span> <span class="o">*</span> <span class="n">lat_rad</span><span class="p">))</span>

        <span class="n">easting</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">K0</span> <span class="o">*</span> <span class="n">n</span> <span class="o">*</span> <span class="p">(</span><span class="n">a</span> <span class="o">+</span>
                                 <span class="n">a3</span> <span class="o">/</span> <span class="mi">6</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">lat_tan2</span> <span class="o">+</span> <span class="n">c</span><span class="p">)</span> <span class="o">+</span>
                                 <span class="n">a5</span> <span class="o">/</span> <span class="mi">120</span> <span class="o">*</span> <span class="p">(</span><span class="mi">5</span> <span class="o">-</span> <span class="mi">18</span> <span class="o">*</span> <span class="n">lat_tan2</span> <span class="o">+</span> <span class="n">lat_tan4</span> <span class="o">+</span> <span class="mi">72</span> <span class="o">*</span> <span class="n">c</span> <span class="o">-</span> <span class="mi">58</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">E_P2</span><span class="p">))</span> <span class="o">+</span> <span class="mi">500000</span>

        <span class="n">northing</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">K0</span> <span class="o">*</span> <span class="p">(</span><span class="n">m</span> <span class="o">+</span> <span class="n">n</span> <span class="o">*</span> <span class="n">lat_tan</span> <span class="o">*</span> <span class="p">(</span><span class="n">a2</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">+</span>
                                                 <span class="n">a4</span> <span class="o">/</span> <span class="mi">24</span> <span class="o">*</span> <span class="p">(</span><span class="mi">5</span> <span class="o">-</span> <span class="n">lat_tan2</span> <span class="o">+</span> <span class="mi">9</span> <span class="o">*</span> <span class="n">c</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">c</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span>
                                                 <span class="n">a6</span> <span class="o">/</span> <span class="mi">720</span> <span class="o">*</span> <span class="p">(</span>
                                                             <span class="mi">61</span> <span class="o">-</span> <span class="mi">58</span> <span class="o">*</span> <span class="n">lat_tan2</span> <span class="o">+</span> <span class="n">lat_tan4</span> <span class="o">+</span> <span class="mi">600</span> <span class="o">*</span> <span class="n">c</span> <span class="o">-</span> <span class="mi">330</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">E_P2</span><span class="p">)))</span>

        <span class="k">if</span> <span class="n">latitude</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">northing</span> <span class="o">+=</span> <span class="mi">10000000</span>

        <span class="k">return</span> <span class="n">easting</span><span class="p">,</span> <span class="n">northing</span><span class="p">,</span> <span class="n">zone_number</span><span class="p">,</span> <span class="n">zone_letter</span>

    <span class="k">def</span> <span class="nf">latitude_to_zone_letter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">latitude</span><span class="p">):</span>
        <span class="k">if</span> <span class="o">-</span><span class="mi">80</span> <span class="o">&lt;=</span> <span class="n">latitude</span> <span class="o">&lt;=</span> <span class="mi">84</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ZONE_LETTERS</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">latitude</span> <span class="o">+</span> <span class="mi">80</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">latlon_to_zone_number</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">latitude</span><span class="p">,</span> <span class="n">longitude</span><span class="p">):</span>
        <span class="k">if</span> <span class="mi">56</span> <span class="o">&lt;=</span> <span class="n">latitude</span> <span class="o">&lt;</span> <span class="mi">64</span> <span class="ow">and</span> <span class="mi">3</span> <span class="o">&lt;=</span> <span class="n">longitude</span> <span class="o">&lt;</span> <span class="mi">12</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">32</span>

        <span class="k">if</span> <span class="mi">72</span> <span class="o">&lt;=</span> <span class="n">latitude</span> <span class="o">&lt;=</span> <span class="mi">84</span> <span class="ow">and</span> <span class="n">longitude</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">longitude</span> <span class="o">&lt;=</span> <span class="mi">9</span><span class="p">:</span>
                <span class="k">return</span> <span class="mi">31</span>
            <span class="k">elif</span> <span class="n">longitude</span> <span class="o">&lt;=</span> <span class="mi">21</span><span class="p">:</span>
                <span class="k">return</span> <span class="mi">33</span>
            <span class="k">elif</span> <span class="n">longitude</span> <span class="o">&lt;=</span> <span class="mi">33</span><span class="p">:</span>
                <span class="k">return</span> <span class="mi">35</span>
            <span class="k">elif</span> <span class="n">longitude</span> <span class="o">&lt;=</span> <span class="mi">42</span><span class="p">:</span>
                <span class="k">return</span> <span class="mi">37</span>

        <span class="k">return</span> <span class="nb">int</span><span class="p">((</span><span class="n">longitude</span> <span class="o">+</span> <span class="mi">180</span><span class="p">)</span> <span class="o">/</span> <span class="mi">6</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>

    <span class="k">def</span> <span class="nf">zone_number_to_central_longitude</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">zone_number</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">zone_number</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">6</span> <span class="o">-</span> <span class="mi">180</span> <span class="o">+</span> <span class="mi">3</span>

    <span class="c1">############################################################################</span>
    <span class="c1"># End Sudipta&#39;s addition</span>
    <span class="c1">############################################################################</span>

    <span class="c1"># Define functions used to construct image observations</span>
    <span class="k">def</span> <span class="nf">LOSVec</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Lat</span><span class="p">,</span> <span class="n">Lon</span><span class="p">,</span> <span class="n">Zen</span><span class="p">,</span> <span class="n">Az</span><span class="p">):</span>
        <span class="n">LSRx</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">sin</span><span class="p">(</span><span class="n">Lon</span><span class="p">),</span> <span class="n">cos</span><span class="p">(</span><span class="n">Lon</span><span class="p">),</span> <span class="mf">0.0</span><span class="p">)</span>
        <span class="n">LSRy</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">sin</span><span class="p">(</span><span class="n">Lat</span><span class="p">)</span> <span class="o">*</span> <span class="n">cos</span><span class="p">(</span><span class="n">Lon</span><span class="p">),</span> <span class="o">-</span><span class="n">sin</span><span class="p">(</span><span class="n">Lat</span><span class="p">)</span> <span class="o">*</span> <span class="n">sin</span><span class="p">(</span><span class="n">Lon</span><span class="p">),</span> <span class="n">cos</span><span class="p">(</span><span class="n">Lat</span><span class="p">))</span>
        <span class="n">LSRz</span> <span class="o">=</span> <span class="p">(</span><span class="n">cos</span><span class="p">(</span><span class="n">Lat</span><span class="p">)</span> <span class="o">*</span> <span class="n">cos</span><span class="p">(</span><span class="n">Lon</span><span class="p">),</span> <span class="n">cos</span><span class="p">(</span><span class="n">Lat</span><span class="p">)</span> <span class="o">*</span> <span class="n">sin</span><span class="p">(</span><span class="n">Lon</span><span class="p">),</span> <span class="n">sin</span><span class="p">(</span><span class="n">Lat</span><span class="p">))</span>
        <span class="n">LOS</span> <span class="o">=</span> <span class="p">(</span><span class="n">sin</span><span class="p">(</span><span class="n">Zen</span><span class="p">)</span> <span class="o">*</span> <span class="n">sin</span><span class="p">(</span><span class="n">Az</span><span class="p">),</span> <span class="n">sin</span><span class="p">(</span><span class="n">Zen</span><span class="p">)</span> <span class="o">*</span> <span class="n">cos</span><span class="p">(</span><span class="n">Az</span><span class="p">),</span> <span class="n">cos</span><span class="p">(</span><span class="n">Zen</span><span class="p">))</span>
        <span class="n">Sat</span> <span class="o">=</span> <span class="p">(</span><span class="n">LOS</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">LSRx</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">LOS</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">LSRy</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">LOS</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="n">LSRz</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
               <span class="n">LOS</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">LSRx</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">LOS</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">LSRy</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">LOS</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="n">LSRz</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
               <span class="n">LOS</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">LSRx</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">LOS</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">LSRy</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">LOS</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="n">LSRz</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="n">Rn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">a</span> <span class="o">/</span> <span class="n">sqrt</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">ecc</span> <span class="o">*</span> <span class="n">sin</span><span class="p">(</span><span class="n">Lat</span><span class="p">)</span> <span class="o">*</span> <span class="n">sin</span><span class="p">(</span><span class="n">Lat</span><span class="p">))</span>
        <span class="n">Gx</span> <span class="o">=</span> <span class="p">(</span><span class="n">Rn</span> <span class="o">*</span> <span class="n">cos</span><span class="p">(</span><span class="n">Lat</span><span class="p">)</span> <span class="o">*</span> <span class="n">cos</span><span class="p">(</span><span class="n">Lon</span><span class="p">),</span>
              <span class="n">Rn</span> <span class="o">*</span> <span class="n">cos</span><span class="p">(</span><span class="n">Lat</span><span class="p">)</span> <span class="o">*</span> <span class="n">sin</span><span class="p">(</span><span class="n">Lon</span><span class="p">),</span>
              <span class="n">Rn</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">ecc</span><span class="p">)</span> <span class="o">*</span> <span class="n">sin</span><span class="p">(</span><span class="n">Lat</span><span class="p">))</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">Sat</span><span class="p">,</span> <span class="n">Gx</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">GrndVec</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Lat</span><span class="p">,</span> <span class="n">Lon</span><span class="p">):</span>
        <span class="n">Rn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">a</span> <span class="o">/</span> <span class="n">sqrt</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">ecc</span> <span class="o">*</span> <span class="n">sin</span><span class="p">(</span><span class="n">Lat</span><span class="p">)</span> <span class="o">*</span> <span class="n">sin</span><span class="p">(</span><span class="n">Lat</span><span class="p">))</span>
        <span class="n">Gx</span> <span class="o">=</span> <span class="p">(</span><span class="n">Rn</span> <span class="o">*</span> <span class="n">cos</span><span class="p">(</span><span class="n">Lat</span><span class="p">)</span> <span class="o">*</span> <span class="n">cos</span><span class="p">(</span><span class="n">Lon</span><span class="p">),</span>
              <span class="n">Rn</span> <span class="o">*</span> <span class="n">cos</span><span class="p">(</span><span class="n">Lat</span><span class="p">)</span> <span class="o">*</span> <span class="n">sin</span><span class="p">(</span><span class="n">Lon</span><span class="p">),</span>
              <span class="n">Rn</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">ecc</span><span class="p">)</span> <span class="o">*</span> <span class="n">sin</span><span class="p">(</span><span class="n">Lat</span><span class="p">))</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">Gx</span><span class="p">)</span>

    <span class="c1"># Inverse (X/Y to lat/long) UTM projection</span>
    <span class="k">def</span> <span class="nf">utm_inv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Zone</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">a</span><span class="o">=</span><span class="mf">6378137.0</span><span class="p">,</span> <span class="n">b</span><span class="o">=</span><span class="mf">6356752.31414</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">Zone</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">FNorth</span> <span class="o">=</span> <span class="mf">10000000.0</span>  <span class="c1"># Southern hemisphere False Northing</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">FNorth</span> <span class="o">=</span> <span class="mf">0.0</span>  <span class="c1"># Northern hemisphere False Northing</span>
        <span class="n">FEast</span> <span class="o">=</span> <span class="mf">500000.0</span>  <span class="c1"># UTM False Easting</span>
        <span class="n">Scale</span> <span class="o">=</span> <span class="mf">0.9996</span>  <span class="c1"># Scale at CM (UTM parameter)</span>
        <span class="n">LatOrigin</span> <span class="o">=</span> <span class="mf">0.0</span>  <span class="c1"># Latitude origin (UTM parameter)</span>
        <span class="n">CMDeg</span> <span class="o">=</span> <span class="o">-</span><span class="mi">177</span> <span class="o">+</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">Zone</span><span class="p">))</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">6</span>
        <span class="n">CM</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">CMDeg</span><span class="p">)</span> <span class="o">*</span> <span class="n">pi</span> <span class="o">/</span> <span class="mf">180.0</span>  <span class="c1"># Central meridian (based on zone)</span>
        <span class="n">ecc</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">-</span> <span class="n">b</span> <span class="o">/</span> <span class="n">a</span> <span class="o">*</span> <span class="n">b</span> <span class="o">/</span> <span class="n">a</span>
        <span class="n">ep</span> <span class="o">=</span> <span class="n">ecc</span> <span class="o">/</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">ecc</span><span class="p">)</span>
        <span class="n">M0</span> <span class="o">=</span> <span class="n">a</span> <span class="o">*</span> <span class="p">((</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">ecc</span> <span class="o">*</span> <span class="p">(</span><span class="mf">0.25</span> <span class="o">+</span> <span class="n">ecc</span> <span class="o">*</span> <span class="p">(</span><span class="mf">3.0</span> <span class="o">/</span> <span class="mf">64.0</span> <span class="o">+</span> <span class="n">ecc</span> <span class="o">*</span> <span class="mf">5.0</span> <span class="o">/</span> <span class="mf">256.0</span><span class="p">)))</span> <span class="o">*</span> <span class="n">LatOrigin</span>
                  <span class="o">-</span> <span class="n">ecc</span> <span class="o">*</span> <span class="p">(</span><span class="mf">0.375</span> <span class="o">+</span> <span class="n">ecc</span> <span class="o">*</span> <span class="p">(</span><span class="mf">3.0</span> <span class="o">/</span> <span class="mf">32.0</span> <span class="o">+</span> <span class="n">ecc</span> <span class="o">*</span> <span class="mf">45.0</span> <span class="o">/</span> <span class="mf">1024.0</span><span class="p">))</span> <span class="o">*</span> <span class="n">sin</span><span class="p">(</span><span class="mf">2.0</span> <span class="o">*</span> <span class="n">LatOrigin</span><span class="p">)</span>
                  <span class="o">+</span> <span class="n">ecc</span> <span class="o">*</span> <span class="n">ecc</span> <span class="o">*</span> <span class="p">(</span><span class="mf">15.0</span> <span class="o">/</span> <span class="mf">256.0</span> <span class="o">+</span> <span class="n">ecc</span> <span class="o">*</span> <span class="mf">45.0</span> <span class="o">/</span> <span class="mf">1024.0</span><span class="p">)</span> <span class="o">*</span> <span class="n">sin</span><span class="p">(</span><span class="mf">4.0</span> <span class="o">*</span> <span class="n">LatOrigin</span><span class="p">)</span>
                  <span class="o">-</span> <span class="n">ecc</span> <span class="o">*</span> <span class="n">ecc</span> <span class="o">*</span> <span class="n">ecc</span> <span class="o">*</span> <span class="mf">35.0</span> <span class="o">/</span> <span class="mf">3072.0</span> <span class="o">*</span> <span class="n">sin</span><span class="p">(</span><span class="mf">6.0</span> <span class="o">*</span> <span class="n">LatOrigin</span><span class="p">))</span>
        <span class="n">M</span> <span class="o">=</span> <span class="n">M0</span> <span class="o">+</span> <span class="p">(</span><span class="n">Y</span> <span class="o">-</span> <span class="n">FNorth</span><span class="p">)</span> <span class="o">/</span> <span class="n">Scale</span>
        <span class="n">Mu</span> <span class="o">=</span> <span class="n">M</span> <span class="o">/</span> <span class="p">(</span><span class="n">a</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">ecc</span> <span class="o">*</span> <span class="p">(</span><span class="mf">0.25</span> <span class="o">+</span> <span class="n">ecc</span> <span class="o">*</span> <span class="p">(</span><span class="mf">3.0</span> <span class="o">/</span> <span class="mf">64.0</span> <span class="o">+</span> <span class="n">ecc</span> <span class="o">*</span> <span class="mf">5.0</span> <span class="o">/</span> <span class="mf">256.0</span><span class="p">))))</span>
        <span class="n">e1</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">sqrt</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">ecc</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="n">sqrt</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">ecc</span><span class="p">))</span>
        <span class="n">Phi1</span> <span class="o">=</span> <span class="n">Mu</span> <span class="o">+</span> <span class="p">(</span><span class="n">e1</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.5</span> <span class="o">-</span> <span class="mf">27.0</span> <span class="o">/</span> <span class="mf">32.0</span> <span class="o">*</span> <span class="n">e1</span> <span class="o">*</span> <span class="n">e1</span><span class="p">)</span> <span class="o">*</span> <span class="n">sin</span><span class="p">(</span><span class="mf">2.0</span> <span class="o">*</span> <span class="n">Mu</span><span class="p">)</span>
                     <span class="o">+</span> <span class="n">e1</span> <span class="o">*</span> <span class="n">e1</span> <span class="o">*</span> <span class="p">(</span><span class="mf">21.0</span> <span class="o">/</span> <span class="mf">16.0</span> <span class="o">-</span> <span class="mf">55.0</span> <span class="o">/</span> <span class="mf">32.0</span> <span class="o">*</span> <span class="n">e1</span> <span class="o">*</span> <span class="n">e1</span><span class="p">)</span> <span class="o">*</span> <span class="n">sin</span><span class="p">(</span><span class="mf">4.0</span> <span class="o">*</span> <span class="n">Mu</span><span class="p">)</span>
                     <span class="o">+</span> <span class="mf">151.0</span> <span class="o">/</span> <span class="mf">96.0</span> <span class="o">*</span> <span class="n">e1</span> <span class="o">*</span> <span class="n">e1</span> <span class="o">*</span> <span class="n">e1</span> <span class="o">*</span> <span class="n">sin</span><span class="p">(</span><span class="mf">6.0</span> <span class="o">*</span> <span class="n">Mu</span><span class="p">)</span>
                     <span class="o">+</span> <span class="mf">1097.0</span> <span class="o">/</span> <span class="mf">512.0</span> <span class="o">*</span> <span class="n">e1</span> <span class="o">*</span> <span class="n">e1</span> <span class="o">*</span> <span class="n">e1</span> <span class="o">*</span> <span class="n">e1</span> <span class="o">*</span> <span class="n">sin</span><span class="p">(</span><span class="mf">8.0</span> <span class="o">*</span> <span class="n">Mu</span><span class="p">))</span>
        <span class="n">slat</span> <span class="o">=</span> <span class="n">sin</span><span class="p">(</span><span class="n">Phi1</span><span class="p">)</span>
        <span class="n">clat</span> <span class="o">=</span> <span class="n">cos</span><span class="p">(</span><span class="n">Phi1</span><span class="p">)</span>
        <span class="n">Rn1</span> <span class="o">=</span> <span class="n">a</span> <span class="o">/</span> <span class="n">sqrt</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">ecc</span> <span class="o">*</span> <span class="n">slat</span> <span class="o">*</span> <span class="n">slat</span><span class="p">)</span>
        <span class="n">T1</span> <span class="o">=</span> <span class="n">slat</span> <span class="o">*</span> <span class="n">slat</span> <span class="o">/</span> <span class="n">clat</span> <span class="o">/</span> <span class="n">clat</span>
        <span class="n">C1</span> <span class="o">=</span> <span class="n">ep</span> <span class="o">*</span> <span class="n">clat</span> <span class="o">*</span> <span class="n">clat</span>
        <span class="n">R1</span> <span class="o">=</span> <span class="n">Rn1</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">ecc</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">ecc</span> <span class="o">*</span> <span class="n">slat</span> <span class="o">*</span> <span class="n">slat</span><span class="p">)</span>
        <span class="n">D</span> <span class="o">=</span> <span class="p">(</span><span class="n">X</span> <span class="o">-</span> <span class="n">FEast</span><span class="p">)</span> <span class="o">/</span> <span class="n">Rn1</span> <span class="o">/</span> <span class="n">Scale</span>
        <span class="c1"># Calculate Lat/Lon</span>
        <span class="n">Lat</span> <span class="o">=</span> <span class="n">Phi1</span> <span class="o">-</span> <span class="p">(</span><span class="n">Rn1</span> <span class="o">*</span> <span class="n">slat</span> <span class="o">/</span> <span class="n">clat</span> <span class="o">/</span> <span class="n">R1</span> <span class="o">*</span> <span class="p">(</span><span class="n">D</span> <span class="o">*</span> <span class="n">D</span> <span class="o">/</span> <span class="mf">2.0</span>
                                                <span class="o">-</span> <span class="p">(</span>
                                                        <span class="mf">5.0</span> <span class="o">+</span> <span class="mf">3.0</span> <span class="o">*</span> <span class="n">T1</span> <span class="o">+</span> <span class="mf">10.0</span> <span class="o">*</span> <span class="n">C1</span> <span class="o">-</span> <span class="mf">4.0</span> <span class="o">*</span> <span class="n">C1</span> <span class="o">*</span> <span class="n">C1</span> <span class="o">-</span> <span class="mf">9.0</span> <span class="o">*</span> <span class="n">ep</span><span class="p">)</span> <span class="o">*</span> <span class="n">D</span> <span class="o">*</span> <span class="n">D</span> <span class="o">*</span> <span class="n">D</span> <span class="o">*</span> <span class="n">D</span> <span class="o">/</span> <span class="mf">24.0</span>
                                                <span class="o">+</span> <span class="p">(</span>
                                                        <span class="mf">61.0</span> <span class="o">+</span> <span class="mf">90.0</span> <span class="o">*</span> <span class="n">T1</span> <span class="o">+</span> <span class="mf">298.0</span> <span class="o">*</span> <span class="n">C1</span> <span class="o">+</span> <span class="mf">45.0</span> <span class="o">*</span> <span class="n">T1</span> <span class="o">*</span> <span class="n">T1</span> <span class="o">-</span> <span class="mf">252.0</span> <span class="o">*</span> <span class="n">ep</span> <span class="o">-</span> <span class="mf">3.0</span> <span class="o">*</span> <span class="n">C1</span> <span class="o">*</span> <span class="n">C1</span><span class="p">)</span> <span class="o">*</span> <span class="n">D</span> <span class="o">*</span> <span class="n">D</span> <span class="o">*</span> <span class="n">D</span> <span class="o">*</span> <span class="n">D</span> <span class="o">*</span> <span class="n">D</span> <span class="o">*</span> <span class="n">D</span> <span class="o">/</span> <span class="mf">720.0</span><span class="p">))</span>
        <span class="n">Lon</span> <span class="o">=</span> <span class="n">CM</span> <span class="o">+</span> <span class="p">(</span><span class="n">D</span> <span class="o">-</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">T1</span> <span class="o">+</span> <span class="n">C1</span><span class="p">)</span> <span class="o">*</span> <span class="n">D</span> <span class="o">*</span> <span class="n">D</span> <span class="o">*</span> <span class="n">D</span> <span class="o">/</span> <span class="mf">6.0</span> <span class="o">+</span> <span class="p">(</span>
                <span class="mf">5.0</span> <span class="o">-</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">C1</span> <span class="o">+</span> <span class="mf">28.0</span> <span class="o">*</span> <span class="n">T1</span> <span class="o">-</span> <span class="mf">3.0</span> <span class="o">*</span> <span class="n">C1</span> <span class="o">*</span> <span class="n">C1</span> <span class="o">+</span> <span class="mf">8.0</span> <span class="o">*</span> <span class="n">ep</span> <span class="o">+</span> <span class="mf">24.0</span> <span class="o">*</span> <span class="n">T1</span> <span class="o">*</span> <span class="n">T1</span><span class="p">)</span>
                    <span class="o">*</span> <span class="n">D</span> <span class="o">*</span> <span class="n">D</span> <span class="o">*</span> <span class="n">D</span> <span class="o">*</span> <span class="n">D</span> <span class="o">*</span> <span class="n">D</span> <span class="o">/</span> <span class="mf">120.0</span><span class="p">)</span> <span class="o">/</span> <span class="n">clat</span>

        <span class="k">return</span> <span class="p">(</span><span class="n">Lat</span><span class="p">,</span> <span class="n">Lon</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_angleobs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">XML_File</span><span class="p">):</span>
        <span class="c1"># Parse the XML file</span>
        <span class="n">tree</span> <span class="o">=</span> <span class="n">ET</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">XML_File</span><span class="p">)</span>
        <span class="n">root</span> <span class="o">=</span> <span class="n">tree</span><span class="o">.</span><span class="n">getroot</span><span class="p">()</span>

        <span class="c1"># Find the angles</span>
        <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">root</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">child</span><span class="o">.</span><span class="n">tag</span><span class="p">[</span><span class="o">-</span><span class="mi">12</span><span class="p">:]</span> <span class="o">==</span> <span class="s1">&#39;General_Info&#39;</span><span class="p">:</span>
                <span class="n">geninfo</span> <span class="o">=</span> <span class="n">child</span>
            <span class="k">if</span> <span class="n">child</span><span class="o">.</span><span class="n">tag</span><span class="p">[</span><span class="o">-</span><span class="mi">14</span><span class="p">:]</span> <span class="o">==</span> <span class="s1">&#39;Geometric_Info&#39;</span><span class="p">:</span>
                <span class="n">geoinfo</span> <span class="o">=</span> <span class="n">child</span>

        <span class="k">for</span> <span class="n">segment</span> <span class="ow">in</span> <span class="n">geninfo</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">segment</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="s1">&#39;TILE_ID&#39;</span><span class="p">:</span>
                <span class="n">tile_id</span> <span class="o">=</span> <span class="n">segment</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">segment</span> <span class="ow">in</span> <span class="n">geoinfo</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">segment</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="s1">&#39;Tile_Geocoding&#39;</span><span class="p">:</span>
                <span class="n">frame</span> <span class="o">=</span> <span class="n">segment</span>
            <span class="k">if</span> <span class="n">segment</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="s1">&#39;Tile_Angles&#39;</span><span class="p">:</span>
                <span class="n">angles</span> <span class="o">=</span> <span class="n">segment</span>

        <span class="k">for</span> <span class="n">box</span> <span class="ow">in</span> <span class="n">frame</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">box</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="s1">&#39;HORIZONTAL_CS_NAME&#39;</span><span class="p">:</span>
                <span class="n">czone</span> <span class="o">=</span> <span class="n">box</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">strip</span><span class="p">()[</span><span class="o">-</span><span class="mi">3</span><span class="p">:]</span>
                <span class="n">hemis</span> <span class="o">=</span> <span class="n">czone</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">:]</span>
                <span class="n">zone</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">czone</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">box</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="s1">&#39;Size&#39;</span> <span class="ow">and</span> <span class="n">box</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;resolution&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;60&#39;</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">box</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="s1">&#39;NROWS&#39;</span><span class="p">:</span>
                        <span class="n">nrows</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="s1">&#39;NCOLS&#39;</span><span class="p">:</span>
                        <span class="n">ncols</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">box</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="s1">&#39;Geoposition&#39;</span> <span class="ow">and</span> <span class="n">box</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;resolution&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;60&#39;</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">box</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="s1">&#39;ULX&#39;</span><span class="p">:</span>
                        <span class="n">ulx</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="s1">&#39;ULY&#39;</span><span class="p">:</span>
                        <span class="n">uly</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">hemis</span> <span class="o">==</span> <span class="s1">&#39;S&#39;</span><span class="p">:</span>
            <span class="n">lzone</span> <span class="o">=</span> <span class="o">-</span><span class="n">zone</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">lzone</span> <span class="o">=</span> <span class="n">zone</span>
        <span class="n">AngleObs</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;zone&#39;</span><span class="p">:</span> <span class="n">zone</span><span class="p">,</span> <span class="s1">&#39;hemis&#39;</span><span class="p">:</span> <span class="n">hemis</span><span class="p">,</span> <span class="s1">&#39;nrows&#39;</span><span class="p">:</span> <span class="n">nrows</span><span class="p">,</span> <span class="s1">&#39;ncols&#39;</span><span class="p">:</span> <span class="n">ncols</span><span class="p">,</span> <span class="s1">&#39;ul_x&#39;</span><span class="p">:</span> <span class="n">ulx</span><span class="p">,</span> <span class="s1">&#39;ul_y&#39;</span><span class="p">:</span> <span class="n">uly</span><span class="p">,</span> <span class="s1">&#39;obs&#39;</span><span class="p">:</span> <span class="p">[]}</span>

        <span class="k">for</span> <span class="n">angle</span> <span class="ow">in</span> <span class="n">angles</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">angle</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="s1">&#39;Viewing_Incidence_Angles_Grids&#39;</span><span class="p">:</span>
                <span class="n">bandId</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">angle</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;bandId&#39;</span><span class="p">])</span>
                <span class="n">detectorId</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">angle</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;detectorId&#39;</span><span class="p">])</span>
                <span class="k">for</span> <span class="n">bset</span> <span class="ow">in</span> <span class="n">angle</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">bset</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="s1">&#39;Zenith&#39;</span><span class="p">:</span>
                        <span class="n">zenith</span> <span class="o">=</span> <span class="n">bset</span>
                    <span class="k">if</span> <span class="n">bset</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="s1">&#39;Azimuth&#39;</span><span class="p">:</span>
                        <span class="n">azimuth</span> <span class="o">=</span> <span class="n">bset</span>
                <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">zenith</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="s1">&#39;COL_STEP&#39;</span><span class="p">:</span>
                        <span class="n">col_step</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="s1">&#39;ROW_STEP&#39;</span><span class="p">:</span>
                        <span class="n">row_step</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="s1">&#39;Values_List&#39;</span><span class="p">:</span>
                        <span class="n">zvallist</span> <span class="o">=</span> <span class="n">field</span>
                <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">azimuth</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="s1">&#39;Values_List&#39;</span><span class="p">:</span>
                        <span class="n">avallist</span> <span class="o">=</span> <span class="n">field</span>
                <span class="k">for</span> <span class="n">rindex</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">zvallist</span><span class="p">)):</span>
                    <span class="n">zvalrow</span> <span class="o">=</span> <span class="n">zvallist</span><span class="p">[</span><span class="n">rindex</span><span class="p">]</span>
                    <span class="n">avalrow</span> <span class="o">=</span> <span class="n">avallist</span><span class="p">[</span><span class="n">rindex</span><span class="p">]</span>
                    <span class="n">zvalues</span> <span class="o">=</span> <span class="n">zvalrow</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
                    <span class="n">avalues</span> <span class="o">=</span> <span class="n">avalrow</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
                    <span class="n">values</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">zvalues</span><span class="p">,</span> <span class="n">avalues</span><span class="p">))</span>
                    <span class="n">ycoord</span> <span class="o">=</span> <span class="n">uly</span> <span class="o">-</span> <span class="n">rindex</span> <span class="o">*</span> <span class="n">row_step</span>
                    <span class="k">for</span> <span class="n">cindex</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">values</span><span class="p">)):</span>
                        <span class="n">xcoord</span> <span class="o">=</span> <span class="n">ulx</span> <span class="o">+</span> <span class="n">cindex</span> <span class="o">*</span> <span class="n">col_step</span>
                        <span class="p">(</span><span class="n">lat</span><span class="p">,</span> <span class="n">lon</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">utm_inv</span><span class="p">(</span><span class="n">lzone</span><span class="p">,</span> <span class="n">xcoord</span><span class="p">,</span> <span class="n">ycoord</span><span class="p">)</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">values</span><span class="p">[</span><span class="n">cindex</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;NaN&#39;</span> <span class="ow">and</span> <span class="n">values</span><span class="p">[</span><span class="n">cindex</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;NaN&#39;</span><span class="p">):</span>
                            <span class="n">zen</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">values</span><span class="p">[</span><span class="n">cindex</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">todeg</span>
                            <span class="n">az</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">values</span><span class="p">[</span><span class="n">cindex</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">todeg</span>
                            <span class="p">(</span><span class="n">Sat</span><span class="p">,</span> <span class="n">Gx</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">LOSVec</span><span class="p">(</span><span class="n">lat</span><span class="p">,</span> <span class="n">lon</span><span class="p">,</span> <span class="n">zen</span><span class="p">,</span> <span class="n">az</span><span class="p">)</span>
                            <span class="n">observe</span> <span class="o">=</span> <span class="p">[</span><span class="n">bandId</span><span class="p">,</span> <span class="n">detectorId</span><span class="p">,</span> <span class="n">xcoord</span><span class="p">,</span> <span class="n">ycoord</span><span class="p">,</span> <span class="n">Sat</span><span class="p">,</span> <span class="n">Gx</span><span class="p">]</span>
                            <span class="n">AngleObs</span><span class="p">[</span><span class="s1">&#39;obs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">observe</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">(</span><span class="n">tile_id</span><span class="p">,</span> <span class="n">AngleObs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_detfootprint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">XML_File</span><span class="p">):</span>
        <span class="c1"># Extract the directory</span>
        <span class="n">Foot_Dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">XML_File</span><span class="p">)</span>
        <span class="n">Foot_Dir</span> <span class="o">+=</span> <span class="s1">&#39;/QI_DATA/&#39;</span>

        <span class="c1"># Parse the XML file</span>
        <span class="n">tree</span> <span class="o">=</span> <span class="n">ET</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">XML_File</span><span class="p">)</span>
        <span class="n">root</span> <span class="o">=</span> <span class="n">tree</span><span class="o">.</span><span class="n">getroot</span><span class="p">()</span>

        <span class="c1"># Find the detector footprint files</span>
        <span class="n">footprints</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">root</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">child</span><span class="o">.</span><span class="n">tag</span><span class="p">[</span><span class="o">-</span><span class="mi">23</span><span class="p">:]</span> <span class="o">==</span> <span class="s1">&#39;Quality_Indicators_Info&#39;</span><span class="p">:</span>
                <span class="n">qualinfo</span> <span class="o">=</span> <span class="n">child</span>

        <span class="k">for</span> <span class="n">segment</span> <span class="ow">in</span> <span class="n">qualinfo</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">segment</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="s1">&#39;Pixel_Level_QI&#39;</span><span class="p">:</span>
                <span class="n">pixlevel</span> <span class="o">=</span> <span class="n">segment</span>

        <span class="k">for</span> <span class="n">qifile</span> <span class="ow">in</span> <span class="n">pixlevel</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">qifile</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="s1">&#39;MASK_FILENAME&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">qifile</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;MSK_DETFOO&#39;</span><span class="p">:</span>
                    <span class="n">bandId</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">qifile</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;bandId&#39;</span><span class="p">])</span>
                    <span class="n">qifname</span> <span class="o">=</span> <span class="n">Foot_Dir</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">qifile</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
                    <span class="n">footprints</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">bandId</span><span class="p">,</span> <span class="n">qifname</span><span class="p">))</span>

        <span class="n">bandfoot</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">foot</span> <span class="ow">in</span> <span class="n">footprints</span><span class="p">:</span>
            <span class="n">bandId</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">foot</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">tree2</span> <span class="o">=</span> <span class="n">ET</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">foot</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">root2</span> <span class="o">=</span> <span class="n">tree2</span><span class="o">.</span><span class="n">getroot</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">root2</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">child</span><span class="o">.</span><span class="n">tag</span><span class="p">[</span><span class="o">-</span><span class="mi">11</span><span class="p">:]</span> <span class="o">==</span> <span class="s1">&#39;maskMembers&#39;</span><span class="p">:</span>
                    <span class="n">thismember</span> <span class="o">=</span> <span class="n">child</span>
                    <span class="k">for</span> <span class="n">feature</span> <span class="ow">in</span> <span class="n">thismember</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">feature</span><span class="o">.</span><span class="n">tag</span><span class="p">[</span><span class="o">-</span><span class="mi">11</span><span class="p">:]</span> <span class="o">==</span> <span class="s1">&#39;MaskFeature&#39;</span><span class="p">:</span>
                            <span class="k">for</span> <span class="n">thisattribute</span> <span class="ow">in</span> <span class="n">feature</span><span class="o">.</span><span class="n">attrib</span><span class="p">:</span>
                                <span class="k">if</span> <span class="n">thisattribute</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">:]</span> <span class="o">==</span> <span class="s1">&#39;id&#39;</span><span class="p">:</span>
                                    <span class="n">detId</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">feature</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="n">thisattribute</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)[</span><span class="mi">2</span><span class="p">])</span>
                                    <span class="n">bandName</span> <span class="o">=</span> <span class="n">feature</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="n">thisattribute</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
                                    <span class="n">thisband</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;detId&#39;</span><span class="p">:</span> <span class="n">detId</span><span class="p">,</span> <span class="s1">&#39;bandId&#39;</span><span class="p">:</span> <span class="n">bandId</span><span class="p">,</span> <span class="s1">&#39;bandName&#39;</span><span class="p">:</span> <span class="n">bandName</span><span class="p">,</span> <span class="s1">&#39;coords&#39;</span><span class="p">:</span> <span class="p">[]}</span>
                            <span class="n">thisfeature</span> <span class="o">=</span> <span class="n">feature</span>
                            <span class="k">for</span> <span class="n">extent</span> <span class="ow">in</span> <span class="n">thisfeature</span><span class="p">:</span>
                                <span class="k">if</span> <span class="n">extent</span><span class="o">.</span><span class="n">tag</span><span class="p">[</span><span class="o">-</span><span class="mi">8</span><span class="p">:]</span> <span class="o">==</span> <span class="s1">&#39;extentOf&#39;</span><span class="p">:</span>
                                    <span class="n">thisextent</span> <span class="o">=</span> <span class="n">extent</span>
                                    <span class="k">for</span> <span class="n">polygon</span> <span class="ow">in</span> <span class="n">thisextent</span><span class="p">:</span>
                                        <span class="k">if</span> <span class="n">polygon</span><span class="o">.</span><span class="n">tag</span><span class="p">[</span><span class="o">-</span><span class="mi">7</span><span class="p">:]</span> <span class="o">==</span> <span class="s1">&#39;Polygon&#39;</span><span class="p">:</span>
                                            <span class="n">thispolygon</span> <span class="o">=</span> <span class="n">polygon</span>
                                            <span class="k">for</span> <span class="n">exterior</span> <span class="ow">in</span> <span class="n">thispolygon</span><span class="p">:</span>
                                                <span class="k">if</span> <span class="n">exterior</span><span class="o">.</span><span class="n">tag</span><span class="p">[</span><span class="o">-</span><span class="mi">8</span><span class="p">:]</span> <span class="o">==</span> <span class="s1">&#39;exterior&#39;</span><span class="p">:</span>
                                                    <span class="n">thisexterior</span> <span class="o">=</span> <span class="n">exterior</span>
                                                    <span class="k">for</span> <span class="n">ring</span> <span class="ow">in</span> <span class="n">thisexterior</span><span class="p">:</span>
                                                        <span class="k">if</span> <span class="n">ring</span><span class="o">.</span><span class="n">tag</span><span class="p">[</span><span class="o">-</span><span class="mi">10</span><span class="p">:]</span> <span class="o">==</span> <span class="s1">&#39;LinearRing&#39;</span><span class="p">:</span>
                                                            <span class="n">thisring</span> <span class="o">=</span> <span class="n">ring</span>
                                                            <span class="k">for</span> <span class="n">poslist</span> <span class="ow">in</span> <span class="n">thisring</span><span class="p">:</span>
                                                                <span class="k">if</span> <span class="n">poslist</span><span class="o">.</span><span class="n">tag</span><span class="p">[</span><span class="o">-</span><span class="mi">7</span><span class="p">:]</span> <span class="o">==</span> <span class="s1">&#39;posList&#39;</span><span class="p">:</span>
                                                                    <span class="n">ncoord</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">poslist</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;srsDimension&#39;</span><span class="p">])</span>
                                                                    <span class="n">fields</span> <span class="o">=</span> <span class="n">poslist</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
                                                                    <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span>
                                                                    <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">:</span>
                                                                        <span class="k">if</span> <span class="n">index</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                                                                            <span class="n">x</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">field</span><span class="p">)</span>
                                                                        <span class="k">elif</span> <span class="n">index</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                                                                            <span class="n">y</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">field</span><span class="p">)</span>
                                                                            <span class="n">thisband</span><span class="p">[</span><span class="s1">&#39;coords&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">))</span>
                                                                        <span class="n">index</span> <span class="o">=</span> <span class="p">(</span><span class="n">index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">ncoord</span>
                                                                    <span class="n">bandfoot</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">thisband</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">bandfoot</span>

    <span class="c1"># Define functions used to construct image observations</span>
    <span class="k">def</span> <span class="nf">Magnitude</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">A</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">A</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">A</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">A</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">A</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">A</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="n">A</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">Dot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">B</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">A</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">B</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">A</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">B</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">A</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="n">B</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">CalcObs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obs</span><span class="p">,</span> <span class="n">Orbit</span><span class="p">,</span> <span class="n">Omega0</span><span class="p">,</span> <span class="n">Lon0</span><span class="p">):</span>
        <span class="n">Vx</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">]</span>
        <span class="n">ltime</span> <span class="o">=</span> <span class="n">obs</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span>
        <span class="n">Sat</span> <span class="o">=</span> <span class="n">obs</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
        <span class="n">Gx</span> <span class="o">=</span> <span class="n">obs</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span>
        <span class="n">cta</span> <span class="o">=</span> <span class="n">Omega0</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">pi</span> <span class="o">*</span> <span class="n">ltime</span> <span class="o">/</span> <span class="n">Orbit</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
        <span class="n">gclat</span> <span class="o">=</span> <span class="n">asin</span><span class="p">(</span><span class="n">sin</span><span class="p">(</span><span class="n">cta</span><span class="p">)</span> <span class="o">*</span> <span class="n">sin</span><span class="p">(</span><span class="n">Orbit</span><span class="p">[</span><span class="mi">3</span><span class="p">]))</span>
        <span class="n">gclon</span> <span class="o">=</span> <span class="n">Lon0</span> <span class="o">+</span> <span class="n">asin</span><span class="p">(</span><span class="n">tan</span><span class="p">(</span><span class="n">gclat</span><span class="p">)</span> <span class="o">/</span> <span class="o">-</span><span class="n">tan</span><span class="p">(</span><span class="n">Orbit</span><span class="p">[</span><span class="mi">3</span><span class="p">]))</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">pi</span> <span class="o">*</span> <span class="n">ltime</span> <span class="o">/</span> <span class="mi">86400</span>
        <span class="n">Vx</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">Orbit</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="n">cos</span><span class="p">(</span><span class="n">gclat</span><span class="p">)</span> <span class="o">*</span> <span class="n">cos</span><span class="p">(</span><span class="n">gclon</span><span class="p">)</span> <span class="o">-</span> <span class="n">Gx</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">Vx</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">Orbit</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="n">cos</span><span class="p">(</span><span class="n">gclat</span><span class="p">)</span> <span class="o">*</span> <span class="n">sin</span><span class="p">(</span><span class="n">gclon</span><span class="p">)</span> <span class="o">-</span> <span class="n">Gx</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">Vx</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">Orbit</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="n">sin</span><span class="p">(</span><span class="n">gclat</span><span class="p">)</span> <span class="o">-</span> <span class="n">Gx</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">Vdist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Magnitude</span><span class="p">(</span><span class="n">Vx</span><span class="p">)</span>
        <span class="n">Vx</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">Vx</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="n">Vdist</span> <span class="o">-</span> <span class="n">Sat</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">Vx</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">Vx</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">Vdist</span> <span class="o">-</span> <span class="n">Sat</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">Vx</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">Vx</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">/</span> <span class="n">Vdist</span> <span class="o">-</span> <span class="n">Sat</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">Vx</span>

    <span class="k">def</span> <span class="nf">Partial_O</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obs</span><span class="p">,</span> <span class="n">Orbit</span><span class="p">):</span>
        <span class="n">P0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
        <span class="n">Omega0</span> <span class="o">=</span> <span class="n">asin</span><span class="p">(</span><span class="n">sin</span><span class="p">(</span><span class="n">Orbit</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="n">sin</span><span class="p">(</span><span class="n">Orbit</span><span class="p">[</span><span class="mi">3</span><span class="p">]))</span>
        <span class="n">Lon0</span> <span class="o">=</span> <span class="n">Orbit</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">asin</span><span class="p">(</span><span class="n">tan</span><span class="p">(</span><span class="n">Orbit</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="o">-</span><span class="n">tan</span><span class="p">(</span><span class="n">Orbit</span><span class="p">[</span><span class="mi">3</span><span class="p">]))</span>
        <span class="n">Dx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">CalcObs</span><span class="p">(</span><span class="n">obs</span><span class="p">,</span> <span class="n">Orbit</span><span class="p">,</span> <span class="n">Omega0</span><span class="p">,</span> <span class="n">Lon0</span><span class="p">)</span>
        <span class="n">POrb</span> <span class="o">=</span> <span class="n">Orbit</span>
        <span class="n">Pert</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.00001</span><span class="p">,</span> <span class="mf">0.00001</span><span class="p">,</span> <span class="mf">10.0</span><span class="p">,</span> <span class="mf">0.0001</span><span class="p">]</span>  <span class="c1"># Perturbations to Lat, Lon, Radius, and Inclination</span>
        <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">Pert</span><span class="p">)):</span>
            <span class="n">POrb</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">+=</span> <span class="n">Pert</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
            <span class="n">Omega0</span> <span class="o">=</span> <span class="n">asin</span><span class="p">(</span><span class="n">sin</span><span class="p">(</span><span class="n">POrb</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="n">sin</span><span class="p">(</span><span class="n">POrb</span><span class="p">[</span><span class="mi">3</span><span class="p">]))</span>
            <span class="n">Lon0</span> <span class="o">=</span> <span class="n">POrb</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">asin</span><span class="p">(</span><span class="n">tan</span><span class="p">(</span><span class="n">POrb</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="o">-</span><span class="n">tan</span><span class="p">(</span><span class="n">POrb</span><span class="p">[</span><span class="mi">3</span><span class="p">]))</span>
            <span class="n">Dp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">CalcObs</span><span class="p">(</span><span class="n">obs</span><span class="p">,</span> <span class="n">POrb</span><span class="p">,</span> <span class="n">Omega0</span><span class="p">,</span> <span class="n">Lon0</span><span class="p">)</span>
            <span class="n">P0</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">Dp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">Dx</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="n">Pert</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
            <span class="n">P0</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">Dp</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">Dx</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="n">Pert</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
            <span class="n">P0</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">Dp</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">Dx</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">/</span> <span class="n">Pert</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
            <span class="n">POrb</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">-=</span> <span class="n">Pert</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">P0</span>

    <span class="k">def</span> <span class="nf">Partial_T</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obs</span><span class="p">,</span> <span class="n">Orbit</span><span class="p">):</span>
        <span class="n">P1</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">]</span>
        <span class="n">Omega0</span> <span class="o">=</span> <span class="n">asin</span><span class="p">(</span><span class="n">sin</span><span class="p">(</span><span class="n">Orbit</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="n">sin</span><span class="p">(</span><span class="n">Orbit</span><span class="p">[</span><span class="mi">3</span><span class="p">]))</span>
        <span class="n">Lon0</span> <span class="o">=</span> <span class="n">Orbit</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">asin</span><span class="p">(</span><span class="n">tan</span><span class="p">(</span><span class="n">Orbit</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="o">-</span><span class="n">tan</span><span class="p">(</span><span class="n">Orbit</span><span class="p">[</span><span class="mi">3</span><span class="p">]))</span>
        <span class="n">Dx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">CalcObs</span><span class="p">(</span><span class="n">obs</span><span class="p">,</span> <span class="n">Orbit</span><span class="p">,</span> <span class="n">Omega0</span><span class="p">,</span> <span class="n">Lon0</span><span class="p">)</span>
        <span class="n">Pobs</span> <span class="o">=</span> <span class="n">obs</span>
        <span class="n">Pert</span> <span class="o">=</span> <span class="mf">0.1</span>  <span class="c1"># Time perturbation</span>
        <span class="n">Pobs</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">+=</span> <span class="n">Pert</span>
        <span class="n">Dp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">CalcObs</span><span class="p">(</span><span class="n">Pobs</span><span class="p">,</span> <span class="n">Orbit</span><span class="p">,</span> <span class="n">Omega0</span><span class="p">,</span> <span class="n">Lon0</span><span class="p">)</span>
        <span class="n">P1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">Dp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">Dx</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="n">Pert</span>
        <span class="n">P1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">Dp</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">Dx</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="n">Pert</span>
        <span class="n">P1</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">Dp</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">Dx</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">/</span> <span class="n">Pert</span>
        <span class="n">Pobs</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">-=</span> <span class="n">Pert</span>

        <span class="k">return</span> <span class="n">P1</span>

    <span class="k">def</span> <span class="nf">Fit_Time</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ul_x</span><span class="p">,</span> <span class="n">ul_y</span><span class="p">,</span> <span class="n">Obs</span><span class="p">):</span>
        <span class="n">Time_Parms</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">band</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">13</span><span class="p">):</span>
            <span class="n">TParm_List</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">sca</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">13</span><span class="p">):</span>
                <span class="n">A0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">matrix</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">)))</span>
                <span class="n">L0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">matrix</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">)))</span>
                <span class="n">X0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">matrix</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">)))</span>
                <span class="k">for</span> <span class="n">los</span> <span class="ow">in</span> <span class="n">Obs</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">los</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">band</span> <span class="ow">and</span> <span class="p">(</span><span class="n">sca</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">los</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">sca</span><span class="p">):</span>
                        <span class="n">dx</span> <span class="o">=</span> <span class="n">los</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">ul_x</span>
                        <span class="n">dy</span> <span class="o">=</span> <span class="n">ul_y</span> <span class="o">-</span> <span class="n">los</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
                        <span class="n">A0</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="mf">1.0</span>
                        <span class="n">A0</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">dx</span>
                        <span class="n">A0</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">+=</span> <span class="n">dy</span>
                        <span class="n">A0</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">+=</span> <span class="n">dx</span> <span class="o">*</span> <span class="n">dy</span>
                        <span class="n">L0</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="n">los</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span>
                        <span class="n">A0</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="n">dx</span>
                        <span class="n">A0</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">dx</span> <span class="o">*</span> <span class="n">dx</span>
                        <span class="n">A0</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">+=</span> <span class="n">dx</span> <span class="o">*</span> <span class="n">dy</span>
                        <span class="n">A0</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">+=</span> <span class="n">dx</span> <span class="o">*</span> <span class="n">dx</span> <span class="o">*</span> <span class="n">dy</span>
                        <span class="n">L0</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="n">dx</span> <span class="o">*</span> <span class="n">los</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span>
                        <span class="n">A0</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="n">dy</span>
                        <span class="n">A0</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">dy</span> <span class="o">*</span> <span class="n">dx</span>
                        <span class="n">A0</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">+=</span> <span class="n">dy</span> <span class="o">*</span> <span class="n">dy</span>
                        <span class="n">A0</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">+=</span> <span class="n">dy</span> <span class="o">*</span> <span class="n">dx</span> <span class="o">*</span> <span class="n">dy</span>
                        <span class="n">L0</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="n">dy</span> <span class="o">*</span> <span class="n">los</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span>
                        <span class="n">A0</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="n">dx</span> <span class="o">*</span> <span class="n">dy</span>
                        <span class="n">A0</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">dx</span> <span class="o">*</span> <span class="n">dy</span> <span class="o">*</span> <span class="n">dx</span>
                        <span class="n">A0</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">+=</span> <span class="n">dx</span> <span class="o">*</span> <span class="n">dy</span> <span class="o">*</span> <span class="n">dy</span>
                        <span class="n">A0</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">+=</span> <span class="n">dx</span> <span class="o">*</span> <span class="n">dy</span> <span class="o">*</span> <span class="n">dx</span> <span class="o">*</span> <span class="n">dy</span>
                        <span class="n">L0</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="n">dx</span> <span class="o">*</span> <span class="n">dy</span> <span class="o">*</span> <span class="n">los</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span>
                <span class="c1"># Detector 0 is the band average solution which is used to strengthen detectors with few points</span>
                <span class="k">if</span> <span class="n">sca</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">A0all</span> <span class="o">=</span> <span class="n">A0</span>
                    <span class="n">L0all</span> <span class="o">=</span> <span class="n">L0</span>
                <span class="c1"># Make sure we have a valid solution for this detector</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">A0inv</span> <span class="o">=</span> <span class="n">A0</span> <span class="o">**</span> <span class="o">-</span><span class="mi">1</span>
                <span class="c1"># Bring in the band average data for the rate terms</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">A0</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">1.0</span><span class="p">:</span>
                        <span class="n">A0</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
                    <span class="n">A0</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">A0all</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
                    <span class="n">A0</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">A0all</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>
                    <span class="n">A0</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">A0all</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>
                    <span class="n">A0</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">A0all</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
                    <span class="n">A0</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">A0all</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>
                    <span class="n">A0</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">A0all</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>
                    <span class="n">A0</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">A0all</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
                    <span class="n">A0</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">A0all</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>
                    <span class="n">A0</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">A0all</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>
                    <span class="n">L0</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">L0all</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
                    <span class="n">L0</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">L0all</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
                    <span class="n">L0</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">L0all</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
                    <span class="n">A0inv</span> <span class="o">=</span> <span class="n">A0</span> <span class="o">**</span> <span class="o">-</span><span class="mi">1</span>
                <span class="n">X0</span> <span class="o">=</span> <span class="n">A0inv</span> <span class="o">*</span> <span class="n">L0</span>
                <span class="n">TParm_List</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">X0</span><span class="p">))</span>
            <span class="n">this_time</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;band&#39;</span><span class="p">:</span> <span class="n">band</span><span class="p">,</span> <span class="s1">&#39;tmodel&#39;</span><span class="p">:</span> <span class="n">TParm_List</span><span class="p">}</span>
            <span class="n">Time_Parms</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">this_time</span><span class="p">)</span>

            <span class="c1"># Calculate fit statistic</span>
            <span class="n">rmsfit</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">numobs</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">coeffs</span> <span class="o">=</span> <span class="n">TParm_List</span>
            <span class="k">for</span> <span class="n">los</span> <span class="ow">in</span> <span class="n">Obs</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">los</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">band</span><span class="p">:</span>
                    <span class="n">det</span> <span class="o">=</span> <span class="n">los</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">dx</span> <span class="o">=</span> <span class="n">los</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">ul_x</span>
                    <span class="n">dy</span> <span class="o">=</span> <span class="n">ul_y</span> <span class="o">-</span> <span class="n">los</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
                    <span class="n">dt</span> <span class="o">=</span> <span class="n">coeffs</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">coeffs</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">dx</span> <span class="o">+</span> <span class="n">coeffs</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="n">dy</span> <span class="o">+</span> <span class="n">coeffs</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span> <span class="o">*</span> <span class="n">dx</span> <span class="o">*</span> <span class="n">dy</span> <span class="o">-</span> <span class="n">los</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span>
                    <span class="n">numobs</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="n">rmsfit</span> <span class="o">+=</span> <span class="n">dt</span> <span class="o">*</span> <span class="n">dt</span>
            <span class="k">if</span> <span class="n">numobs</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">rmsfit</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">rmsfit</span> <span class="o">/</span> <span class="n">numobs</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Time fit for band &#39;</span><span class="p">,</span> <span class="n">band</span><span class="p">,</span> <span class="s1">&#39; RMS = &#39;</span><span class="p">,</span> <span class="n">rmsfit</span><span class="p">,</span> <span class="s1">&#39; seconds&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">Time_Parms</span>

    <span class="k">def</span> <span class="nf">Fit_Orbit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">AngleObs</span><span class="p">):</span>
        <span class="c1"># Initialize the orbit parameters</span>
        <span class="n">Orbit</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">7169868.175</span><span class="p">,</span> <span class="mf">98.62</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">todeg</span><span class="p">,</span>
                 <span class="mf">6041.958</span><span class="p">]</span>  <span class="c1"># Reference Lat, Reference Lon, Radius, Inclination, Period</span>
        <span class="n">Orbit0</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">7169868.175</span><span class="p">,</span> <span class="mf">98.62</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">todeg</span><span class="p">,</span>
                  <span class="mf">6041.958</span><span class="p">]</span>  <span class="c1"># Reference Lat, Reference Lon, Radius, Inclination, Period</span>

        <span class="c1"># Load the angle records</span>
        <span class="n">ul_x</span> <span class="o">=</span> <span class="n">AngleObs</span><span class="p">[</span><span class="s1">&#39;ul_x&#39;</span><span class="p">]</span>
        <span class="n">ul_y</span> <span class="o">=</span> <span class="n">AngleObs</span><span class="p">[</span><span class="s1">&#39;ul_y&#39;</span><span class="p">]</span>
        <span class="n">Obs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">numobs</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">viewrec</span> <span class="ow">in</span> <span class="n">AngleObs</span><span class="p">[</span><span class="s1">&#39;obs&#39;</span><span class="p">]:</span>
            <span class="n">numobs</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="c1"># Construct observation record</span>
            <span class="n">Sat</span> <span class="o">=</span> <span class="p">[</span><span class="n">viewrec</span><span class="p">[</span><span class="mi">4</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">viewrec</span><span class="p">[</span><span class="mi">4</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">viewrec</span><span class="p">[</span><span class="mi">4</span><span class="p">][</span><span class="mi">2</span><span class="p">]]</span>
            <span class="n">Gx</span> <span class="o">=</span> <span class="n">viewrec</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span>
            <span class="n">Obs</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">viewrec</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">viewrec</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">viewrec</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">viewrec</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">viewrec</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">viewrec</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span> <span class="mf">0.0</span><span class="p">])</span>
            <span class="c1"># Project the view vector out to the satellite orbital radius</span>
            <span class="n">Gmag</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Magnitude</span><span class="p">(</span><span class="n">Gx</span><span class="p">)</span>
            <span class="n">Vdot</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Dot</span><span class="p">(</span><span class="n">Sat</span><span class="p">,</span> <span class="n">Gx</span><span class="p">)</span>
            <span class="n">Vdist</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">Orbit</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="n">Orbit</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">Vdot</span> <span class="o">*</span> <span class="n">Vdot</span> <span class="o">-</span> <span class="n">Gmag</span> <span class="o">*</span> <span class="n">Gmag</span><span class="p">)</span>
            <span class="n">Px</span> <span class="o">=</span> <span class="p">[</span><span class="n">Gx</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">Sat</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">Vdist</span><span class="p">,</span> <span class="n">Gx</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">Sat</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">Vdist</span><span class="p">,</span> <span class="n">Gx</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">Sat</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="n">Vdist</span><span class="p">]</span>
            <span class="n">Orbit</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">atan2</span><span class="p">(</span><span class="n">Px</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">Px</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">Orbit</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="n">atan</span><span class="p">(</span><span class="n">Px</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">/</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">Px</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">Px</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">Px</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">Px</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>

        <span class="n">Orbit</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/=</span> <span class="n">numobs</span>
        <span class="n">Orbit</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/=</span> <span class="n">numobs</span>
        <span class="n">Orbit0</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">Orbit</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">Orbit0</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">Orbit</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

        <span class="c1"># Iterate solution for orbital parameters and observation times</span>
        <span class="n">convtol</span> <span class="o">=</span> <span class="mf">0.001</span>  <span class="c1"># 1 millisecond RMS time correction</span>
        <span class="n">rmstime</span> <span class="o">=</span> <span class="mf">15.0</span>
        <span class="n">orbtol</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="n">orbrss</span> <span class="o">=</span> <span class="mf">1000.0</span>
        <span class="n">first_iter</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Reconstructing Orbit from View Angles&#39;</span><span class="p">)</span>
        <span class="k">while</span> <span class="n">rmstime</span> <span class="o">&gt;</span> <span class="n">convtol</span> <span class="ow">or</span> <span class="n">orbrss</span> <span class="o">&gt;</span> <span class="n">orbtol</span><span class="p">:</span>
            <span class="n">AngResid</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="n">Omega0</span> <span class="o">=</span> <span class="n">asin</span><span class="p">(</span><span class="n">sin</span><span class="p">(</span><span class="n">Orbit</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="n">sin</span><span class="p">(</span><span class="n">Orbit</span><span class="p">[</span><span class="mi">3</span><span class="p">]))</span>
            <span class="n">Lon0</span> <span class="o">=</span> <span class="n">Orbit</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">asin</span><span class="p">(</span><span class="n">tan</span><span class="p">(</span><span class="n">Orbit</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="o">-</span><span class="n">tan</span><span class="p">(</span><span class="n">Orbit</span><span class="p">[</span><span class="mi">3</span><span class="p">]))</span>
            <span class="n">A0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">matrix</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">)))</span>
            <span class="n">L0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">matrix</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">)))</span>
            <span class="n">X0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">matrix</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">)))</span>
            <span class="n">M1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">matrix</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">)))</span>
            <span class="n">BackSub</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">los</span> <span class="ow">in</span> <span class="n">Obs</span><span class="p">:</span>
                <span class="n">Vx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">CalcObs</span><span class="p">(</span><span class="n">los</span><span class="p">,</span> <span class="n">Orbit</span><span class="p">,</span> <span class="n">Omega0</span><span class="p">,</span> <span class="n">Lon0</span><span class="p">)</span>
                <span class="n">AngResid</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Dot</span><span class="p">(</span><span class="n">Vx</span><span class="p">,</span> <span class="n">Vx</span><span class="p">)</span>
                <span class="n">V0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">matrix</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">Vx</span><span class="p">))</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="c1"># Calculate the partial derivatives w.r.t. the orbit parameters</span>
                <span class="n">P0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Partial_O</span><span class="p">(</span><span class="n">los</span><span class="p">,</span> <span class="n">Orbit</span><span class="p">)</span>
                <span class="n">P0t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">matrix</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">P0</span><span class="p">))</span>
                <span class="n">P0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">matrix</span><span class="p">(</span><span class="n">P0</span><span class="p">)</span>
                <span class="n">A0</span> <span class="o">=</span> <span class="n">A0</span> <span class="o">+</span> <span class="n">P0t</span> <span class="o">*</span> <span class="n">P0</span>
                <span class="n">L0</span> <span class="o">=</span> <span class="n">L0</span> <span class="o">+</span> <span class="n">P0t</span> <span class="o">*</span> <span class="n">V0</span>
                <span class="n">P1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Partial_T</span><span class="p">(</span><span class="n">los</span><span class="p">,</span> <span class="n">Orbit</span><span class="p">)</span>
                <span class="n">M1</span> <span class="o">=</span> <span class="n">P0t</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">matrix</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">P1</span><span class="p">))</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">A1</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">Dot</span><span class="p">(</span><span class="n">P1</span><span class="p">,</span> <span class="n">P1</span><span class="p">)</span>
                <span class="n">L1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Dot</span><span class="p">(</span><span class="n">P1</span><span class="p">,</span> <span class="n">Vx</span><span class="p">)</span> <span class="o">*</span> <span class="n">A1</span>
                <span class="n">M1t</span> <span class="o">=</span> <span class="n">A1</span> <span class="o">*</span> <span class="n">M1</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
                <span class="n">A0</span> <span class="o">=</span> <span class="n">A0</span> <span class="o">+</span> <span class="n">M1</span> <span class="o">*</span> <span class="n">M1t</span>
                <span class="n">L0</span> <span class="o">=</span> <span class="n">L0</span> <span class="o">+</span> <span class="n">M1</span> <span class="o">*</span> <span class="n">L1</span>
                <span class="n">BackSub</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">L1</span><span class="p">,</span> <span class="n">M1</span> <span class="o">*</span> <span class="n">A1</span><span class="p">])</span>
            <span class="c1"># Solve for Orbital parameter corrections</span>
            <span class="k">if</span> <span class="n">first_iter</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">X0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">matrix</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">)))</span>
                <span class="n">first_iter</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">X0</span> <span class="o">=</span> <span class="p">(</span><span class="n">A0</span> <span class="o">**</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">L0</span>
            <span class="c1"># Back Substitute for Time Corrections</span>
            <span class="n">rmstime</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">Obs</span><span class="p">)):</span>
                <span class="n">dtime</span> <span class="o">=</span> <span class="n">BackSub</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">Dot</span><span class="p">(</span><span class="n">BackSub</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">X0</span><span class="p">)</span>
                <span class="n">rmstime</span> <span class="o">+=</span> <span class="n">dtime</span> <span class="o">*</span> <span class="n">dtime</span>
                <span class="n">Obs</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="mi">6</span><span class="p">]</span> <span class="o">-=</span> <span class="n">dtime</span>
            <span class="c1"># Update Orbit Parameters</span>
            <span class="n">Orbit</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-=</span> <span class="n">X0</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
            <span class="n">Orbit</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-=</span> <span class="n">X0</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
            <span class="n">Orbit</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-=</span> <span class="n">X0</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
            <span class="n">Orbit</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">-=</span> <span class="n">X0</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
            <span class="c1"># Evaluate Observation Residual RMS</span>
            <span class="n">AngResid</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">AngResid</span> <span class="o">/</span> <span class="n">numobs</span><span class="p">)</span>
            <span class="c1"># Evaluate Convergence</span>
            <span class="n">rmstime</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">rmstime</span> <span class="o">/</span> <span class="n">numobs</span><span class="p">)</span>
            <span class="c1"># Orbit Convergence</span>
            <span class="n">X0</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">*=</span> <span class="mf">6378137.0</span>
            <span class="n">X0</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">*=</span> <span class="mf">6378137.0</span>
            <span class="n">X0</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">*=</span> <span class="n">Orbit</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">orbrss</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">X0</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">X0</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">X0</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">X0</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">X0</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">X0</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">X0</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">X0</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Lat    = &#39;</span><span class="p">,</span> <span class="n">Orbit</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">todeg</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Lon    = &#39;</span><span class="p">,</span> <span class="n">Orbit</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">todeg</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Radius = &#39;</span><span class="p">,</span> <span class="n">Orbit</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Incl   = &#39;</span><span class="p">,</span> <span class="n">Orbit</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">todeg</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;RMS Orbit Fit (meters): &#39;</span><span class="p">,</span> <span class="n">orbrss</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;RMS Time Fit (seconds): &#39;</span><span class="p">,</span> <span class="n">rmstime</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;RMS LOS Residual: &#39;</span><span class="p">,</span> <span class="n">AngResid</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Fitting Tile Observation Times&#39;</span><span class="p">)</span>

        <span class="n">Time_Parms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Fit_Time</span><span class="p">(</span><span class="n">ul_x</span><span class="p">,</span> <span class="n">ul_y</span><span class="p">,</span> <span class="n">Obs</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">(</span><span class="n">Orbit</span><span class="p">,</span> <span class="n">Time_Parms</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">CalcOrbit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ltime</span><span class="p">,</span> <span class="n">Orbit</span><span class="p">):</span>
        <span class="n">cta</span> <span class="o">=</span> <span class="n">Orbit</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">pi</span> <span class="o">*</span> <span class="n">ltime</span> <span class="o">/</span> <span class="n">Orbit</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
        <span class="n">gclat</span> <span class="o">=</span> <span class="n">asin</span><span class="p">(</span><span class="n">sin</span><span class="p">(</span><span class="n">cta</span><span class="p">)</span> <span class="o">*</span> <span class="n">sin</span><span class="p">(</span><span class="n">Orbit</span><span class="p">[</span><span class="mi">3</span><span class="p">]))</span>
        <span class="n">gclon</span> <span class="o">=</span> <span class="n">Orbit</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">+</span> <span class="n">asin</span><span class="p">(</span><span class="n">tan</span><span class="p">(</span><span class="n">gclat</span><span class="p">)</span> <span class="o">/</span> <span class="o">-</span><span class="n">tan</span><span class="p">(</span><span class="n">Orbit</span><span class="p">[</span><span class="mi">3</span><span class="p">]))</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">pi</span> <span class="o">*</span> <span class="n">ltime</span> <span class="o">/</span> <span class="mi">86400</span>
        <span class="n">Px</span> <span class="o">=</span> <span class="p">[</span><span class="n">Orbit</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="n">cos</span><span class="p">(</span><span class="n">gclat</span><span class="p">)</span> <span class="o">*</span> <span class="n">cos</span><span class="p">(</span><span class="n">gclon</span><span class="p">),</span> <span class="n">Orbit</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="n">cos</span><span class="p">(</span><span class="n">gclat</span><span class="p">)</span> <span class="o">*</span> <span class="n">sin</span><span class="p">(</span><span class="n">gclon</span><span class="p">),</span> <span class="n">Orbit</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="n">sin</span><span class="p">(</span><span class="n">gclat</span><span class="p">)]</span>
        <span class="k">return</span> <span class="n">Px</span>

    <span class="c1"># def CalcGroundVectors( AngleObs, gsd, subsamp, nrows, ncols ):</span>
    <span class="c1"># sudipta changed above to support spatial subset</span>
    <span class="k">def</span> <span class="nf">CalcGroundVectors</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">AngleObs</span><span class="p">,</span> <span class="n">gsd</span><span class="p">,</span> <span class="n">subsamp</span><span class="p">,</span> <span class="n">start_row</span><span class="p">,</span> <span class="n">end_row</span><span class="p">,</span> <span class="n">start_col</span><span class="p">,</span> <span class="n">end_col</span><span class="p">,</span> <span class="n">out_rows</span><span class="p">,</span> <span class="n">out_cols</span><span class="p">):</span>
        <span class="n">GVecs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">out_rows</span><span class="p">,</span> <span class="n">out_cols</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
        <span class="n">ul_x</span> <span class="o">=</span> <span class="n">AngleObs</span><span class="p">[</span><span class="s1">&#39;ul_x&#39;</span><span class="p">]</span>
        <span class="n">ul_y</span> <span class="o">=</span> <span class="n">AngleObs</span><span class="p">[</span><span class="s1">&#39;ul_y&#39;</span><span class="p">]</span>
        <span class="n">zone</span> <span class="o">=</span> <span class="n">AngleObs</span><span class="p">[</span><span class="s1">&#39;zone&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">AngleObs</span><span class="p">[</span><span class="s1">&#39;hemis&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;S&#39;</span><span class="p">:</span>
            <span class="n">zone</span> <span class="o">*=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="c1"># for row in range( nrows ):</span>
        <span class="c1"># sudipta changed above to support spatial subset</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">start_row</span><span class="p">,</span> <span class="n">end_row</span><span class="p">):</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">ul_y</span> <span class="o">-</span> <span class="nb">float</span><span class="p">(</span><span class="n">row</span> <span class="o">*</span> <span class="n">gsd</span> <span class="o">*</span> <span class="n">subsamp</span><span class="p">)</span> <span class="o">-</span> <span class="n">gsd</span> <span class="o">/</span> <span class="mf">2.0</span>
            <span class="c1"># for col in range( ncols ):</span>
            <span class="c1"># sudipta changed above to support spatial subset</span>
            <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">start_col</span><span class="p">,</span> <span class="n">end_col</span><span class="p">):</span>
                <span class="n">x</span> <span class="o">=</span> <span class="n">ul_x</span> <span class="o">+</span> <span class="nb">float</span><span class="p">(</span><span class="n">col</span> <span class="o">*</span> <span class="n">gsd</span> <span class="o">*</span> <span class="n">subsamp</span><span class="p">)</span> <span class="o">+</span> <span class="n">gsd</span> <span class="o">/</span> <span class="mf">2.0</span>
                <span class="p">(</span><span class="n">lat</span><span class="p">,</span> <span class="n">lon</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">utm_inv</span><span class="p">(</span><span class="n">zone</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
                <span class="n">Gx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">GrndVec</span><span class="p">(</span><span class="n">lat</span><span class="p">,</span> <span class="n">lon</span><span class="p">)</span>
                <span class="n">GVecs</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">Gx</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">GVecs</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">Gx</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">GVecs</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">Gx</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">GVecs</span>

    <span class="k">def</span> <span class="nf">WriteHeader</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Out_File</span><span class="p">,</span> <span class="n">out_rows</span><span class="p">,</span> <span class="n">out_cols</span><span class="p">,</span> <span class="n">ul_x</span><span class="p">,</span> <span class="n">ul_y</span><span class="p">,</span> <span class="n">gsd</span><span class="p">,</span> <span class="n">zone</span><span class="p">,</span> <span class="n">n_or_s</span><span class="p">):</span>
        <span class="n">Hdr_File</span> <span class="o">=</span> <span class="n">Out_File</span> <span class="o">+</span> <span class="s1">&#39;.hdr&#39;</span>
        <span class="k">if</span> <span class="n">n_or_s</span> <span class="o">==</span> <span class="s1">&#39;S&#39;</span><span class="p">:</span>
            <span class="n">hemis</span> <span class="o">=</span> <span class="s1">&#39;South&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">hemis</span> <span class="o">=</span> <span class="s1">&#39;North&#39;</span>
        <span class="n">ofile</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">Hdr_File</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
        <span class="n">ofile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;ENVI</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">ofile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;description = { S2 View Angle Band File }</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">ofile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;lines = </span><span class="si">%d</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">out_rows</span><span class="p">)</span>
        <span class="n">ofile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;samples = </span><span class="si">%d</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">out_cols</span><span class="p">)</span>
        <span class="n">ofile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;bands = 2</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">ofile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;header offset = 0</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">ofile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;file type = ENVI Standard</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">ofile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;data type = 2</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">ofile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;interleave = bsq</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">ofile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;byte order = 0</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">ofile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;x start = 0</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">ofile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;y start = 0</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">ofile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;map info = {UTM, 1.0, 1.0, </span><span class="si">%6.3lf</span><span class="s1">, </span><span class="si">%6.3lf</span><span class="s1">, </span><span class="si">%6.3lf</span><span class="s1">, </span><span class="si">%6.3lf</span><span class="s1">, </span><span class="si">%d</span><span class="s1">, </span><span class="si">%s</span><span class="s1">, WGS-84, units=Meters}</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="n">ul_x</span><span class="p">,</span> <span class="n">ul_y</span><span class="p">,</span> <span class="n">gsd</span><span class="p">,</span> <span class="n">gsd</span><span class="p">,</span> <span class="n">zone</span><span class="p">,</span> <span class="n">hemis</span><span class="p">))</span>
        <span class="n">ofile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;data gain values = {0.01, 0.01}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">ofile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;band names = {Azimuth, Zenith}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">ofile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">Hdr_File</span></div>
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../index.html">grs</a></h1>








<h3>Navigation</h3>
<p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../page.html">Documentation for the GRS algorithm.</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../modules.html">Project Modules</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../fortran_modules.html">Fortran Modules</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../deployment_modules.html">Deployment Modules</a></li>
</ul>


<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2019, Tristan Harmel.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 2.2.1</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
    </div>

    

    
  </body>
</html>