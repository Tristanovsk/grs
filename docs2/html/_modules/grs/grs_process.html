
<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
    <title>grs.grs_process &#8212; grs 1 documentation</title>
    <link rel="stylesheet" href="../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../_static/language_data.js"></script>
    <script async="async" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for grs.grs_process</h1><div class="highlight"><pre>
<span></span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">Main program</span>
<span class="sd">&#39;&#39;&#39;</span>

<span class="kn">from</span> <span class="nn">pathlib</span> <span class="k">import</span> <span class="n">Path</span>
<span class="kn">from</span> <span class="nn">esasnappy</span> <span class="k">import</span> <span class="n">ProductData</span><span class="p">,</span> <span class="n">ProductIO</span>

<span class="kn">import</span> <span class="nn">os</span><span class="o">,</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">zipfile</span>
<span class="kn">import</span> <span class="nn">tarfile</span>
<span class="kn">import</span> <span class="nn">glob</span>

<span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">config</span> <span class="k">as</span> <span class="n">cfg</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">acutils</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">auxdata</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">utils</span>
<span class="kn">from</span> <span class="nn">.anglegen</span> <span class="k">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">.fortran.grs</span> <span class="k">import</span> <span class="n">main_algo</span> <span class="k">as</span> <span class="n">grs_solver</span>
<span class="kn">from</span> <span class="nn">.fortran.grs_a</span> <span class="k">import</span> <span class="n">main_algo</span> <span class="k">as</span> <span class="n">grs_a_solver</span>


<div class="viewcode-block" id="process"><a class="viewcode-back" href="../../_autosummary/grs.grs_process.html#grs.grs_process.process">[docs]</a><span class="k">class</span> <span class="nc">process</span><span class="p">:</span>
    <span class="sd">&#39;&#39;&#39; &#39;&#39;&#39;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>

<div class="viewcode-block" id="process.execute"><a class="viewcode-back" href="../../_autosummary/grs.grs_process.html#grs.grs_process.process.execute">[docs]</a>    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file</span><span class="p">,</span> <span class="n">outfile</span><span class="p">,</span> <span class="n">wkt</span><span class="p">,</span> <span class="n">sensor</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">altitude</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">aerosol</span><span class="o">=</span><span class="s1">&#39;cams_forecast&#39;</span><span class="p">,</span> <span class="n">ancillary</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">dem</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">aeronet_file</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">aot550</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">angstrom</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">resolution</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">unzip</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">untar</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">startrow</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                <span class="n">memory_safe</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">angleonly</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">grs_a</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="s1">&#39;Rrs&#39;</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Main program calling all GRS steps</span>

<span class="sd">        :param file: Input file to be processed</span>
<span class="sd">        :param sensor: Set the sensor type: S2A, S2B, LANDSAT_5, LANDSAT_7, LANDSAT_8</span>
<span class="sd">                    (by default sensor type is retrieved from input file name)</span>
<span class="sd">        :param wkt: Well-Known-Text format defining the area of interest for which the image is subsetted</span>
<span class="sd">        :param outfile: Absolute path of the output file</span>
<span class="sd">        :param dem: if True digital elevation model is applied for per-pixel pressure calculation (data from SNAP/SRTM)</span>
<span class="sd">        :param altitude: provide altitude if `dem` is set as `False`</span>
<span class="sd">        :param aeronet_file: optional aeronet file to be used for aerosol calculations</span>
<span class="sd">        :param resolution: pixel resolution in meters (integer)</span>
<span class="sd">        :param unzip: if True input file is unzipped before processing,</span>
<span class="sd">                      NB: unzipped files are removed at the end of the process</span>
<span class="sd">        :param startrow: row number of the resampled and subset image on which the process starts, recommended value 0</span>
<span class="sd">                        NB: this option is used to in the context of operational processing of massive dataset</span>
<span class="sd">        :param angleonly: if true, grs is used to compute angle parameters only (no atmo correction is applied)</span>
<span class="sd">        :param output: set the unit of the retrievals:</span>

<span class="sd">                 * &#39;Lwn&#39;, normalized water-leaving radiance (in  :math:`mW cm^{-2} sr^{-1} \mu m^{-1})`</span>

<span class="sd">                 * &#39;Rrs&#39;, remote sensing reflectance (in  :math:`sr^{-1}`)</span>

<span class="sd">                 {default: &#39;Rrs&#39;}</span>
<span class="sd">        :param grs_a: switch to grs-a algorithm (Lwn and aerosol) if True</span>

<span class="sd">        :return:</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="c1">##################################</span>
        <span class="c1"># Get sensor auxiliary data</span>
        <span class="c1">##################################</span>
        <span class="n">_utils</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">utils</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">sensor</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">sensor</span> <span class="o">=</span> <span class="n">_utils</span><span class="o">.</span><span class="n">get_sensor</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
        <span class="n">sensordata</span> <span class="o">=</span> <span class="n">auxdata</span><span class="o">.</span><span class="n">sensordata</span><span class="p">(</span><span class="n">sensor</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">resolution</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">resolution</span> <span class="o">=</span> <span class="n">sensordata</span><span class="o">.</span><span class="n">resolution</span>
        <span class="n">indband</span> <span class="o">=</span> <span class="n">sensordata</span><span class="o">.</span><span class="n">indband</span>

        <span class="k">if</span> <span class="n">ancillary</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ancillary</span> <span class="o">=</span> <span class="n">aerosol</span>

        <span class="c1">##################################</span>
        <span class="c1"># Read L1C product</span>
        <span class="c1">##################################</span>
        <span class="n">file_orig</span> <span class="o">=</span> <span class="n">file</span>
        <span class="c1"># unzip if needed</span>
        <span class="k">if</span> <span class="n">unzip</span><span class="p">:</span>
            <span class="n">tmpzip</span> <span class="o">=</span> <span class="n">zipfile</span><span class="o">.</span><span class="n">ZipFile</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
            <span class="n">tmpzip</span><span class="o">.</span><span class="n">extractall</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">tmp_dir</span><span class="p">)</span>
            <span class="n">file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">tmp_dir</span><span class="p">,</span> <span class="n">tmpzip</span><span class="o">.</span><span class="n">namelist</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">tartmp</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">anggen</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">untar</span><span class="p">:</span>
            <span class="n">basename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">file</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.tgz&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="n">tmp_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">tmp_dir</span><span class="p">,</span> <span class="n">basename</span><span class="p">)</span>
            <span class="c1"># open tar archive to add potential file (e.g., angle files)</span>
            <span class="n">tartmp</span> <span class="o">=</span> <span class="n">tarfile</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span>
            <span class="c1"># open tar archive to extract files for data loading</span>
            <span class="n">tmpzip</span> <span class="o">=</span> <span class="n">tarfile</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
            <span class="n">tmpzip</span><span class="o">.</span><span class="n">extractall</span><span class="p">(</span><span class="n">tmp_dir</span><span class="p">)</span>
            <span class="n">file</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">tmp_dir</span> <span class="o">+</span> <span class="s1">&#39;/*MTL.txt&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Reading...&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
        <span class="n">product</span> <span class="o">=</span> <span class="n">ProductIO</span><span class="o">.</span><span class="n">readProduct</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>

        <span class="c1">##################################</span>
        <span class="c1"># Generate l2h object</span>
        <span class="c1">##################################</span>
        <span class="n">l2h</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">product</span><span class="p">,</span> <span class="n">sensordata</span><span class="p">,</span> <span class="n">aerosol</span><span class="p">,</span> <span class="n">ancillary</span><span class="p">,</span> <span class="n">output</span><span class="p">)</span>
        <span class="n">l2h</span><span class="o">.</span><span class="n">headerfile</span> <span class="o">=</span> <span class="n">file</span>

        <span class="c1">##################################</span>
        <span class="c1"># GET METADATA</span>
        <span class="c1">##################################</span>
        <span class="c1"># TODO clean up this part and other metadata to be loaded</span>
        <span class="k">if</span> <span class="s1">&#39;S2&#39;</span> <span class="ow">in</span> <span class="n">sensor</span><span class="p">:</span>
            <span class="n">meta</span> <span class="o">=</span> <span class="n">l2h</span><span class="o">.</span><span class="n">product</span><span class="o">.</span><span class="n">getMetadataRoot</span><span class="p">()</span><span class="o">.</span><span class="n">getElement</span><span class="p">(</span><span class="s1">&#39;Level-1C_User_Product&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">getElement</span><span class="p">(</span>
                <span class="s1">&#39;General_Info&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">getElement</span><span class="p">(</span>
                <span class="s1">&#39;Product_Image_Characteristics&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">getElement</span><span class="p">(</span><span class="s1">&#39;Reflectance_Conversion&#39;</span><span class="p">)</span>
            <span class="n">l2h</span><span class="o">.</span><span class="n">U</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">meta</span><span class="o">.</span><span class="n">getAttribute</span><span class="p">(</span><span class="s1">&#39;U&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">getData</span><span class="p">()))</span>
            <span class="n">l2h</span><span class="o">.</span><span class="n">solar_irr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">indband</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">iband</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">indband</span><span class="p">)),</span> <span class="n">indband</span><span class="p">):</span>
                <span class="n">l2h</span><span class="o">.</span><span class="n">solar_irr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">meta</span><span class="o">.</span><span class="n">getElement</span><span class="p">(</span><span class="s1">&#39;Solar_Irradiance_List&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">getAttributeAt</span><span class="p">(</span><span class="n">iband</span><span class="p">)</span><span class="o">.</span><span class="n">getData</span><span class="p">()))</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">meta</span> <span class="o">=</span> <span class="n">l2h</span><span class="o">.</span><span class="n">product</span><span class="o">.</span><span class="n">getMetadataRoot</span><span class="p">()</span><span class="o">.</span><span class="n">getElement</span><span class="p">(</span><span class="s2">&quot;L1_METADATA_FILE&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">getElement</span><span class="p">(</span><span class="s2">&quot;IMAGE_ATTRIBUTES&quot;</span><span class="p">)</span>
            <span class="n">l2h</span><span class="o">.</span><span class="n">U</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">meta</span><span class="o">.</span><span class="n">getAttribute</span><span class="p">(</span><span class="s1">&#39;EARTH_SUN_DISTANCE&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">getData</span><span class="p">()))</span> <span class="o">**</span> <span class="mi">2</span>
            <span class="n">l2h</span><span class="o">.</span><span class="n">solar_irr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">l2h</span><span class="o">.</span><span class="n">sensordata</span><span class="o">.</span><span class="n">solar_irr</span><span class="p">)[</span><span class="n">indband</span><span class="p">]</span>

        <span class="c1"># convert into mW cm-2 um-1</span>
        <span class="n">l2h</span><span class="o">.</span><span class="n">solar_irr</span> <span class="o">=</span> <span class="n">l2h</span><span class="o">.</span><span class="n">solar_irr</span> <span class="o">/</span> <span class="mi">10</span>

        <span class="c1">##################################</span>
        <span class="c1"># GENERATE BAND ANGLES (LANDSAT)</span>
        <span class="c1">##################################</span>
        <span class="k">if</span> <span class="s1">&#39;LANDSAT_8&#39;</span> <span class="ow">in</span> <span class="n">sensor</span><span class="p">:</span>
            <span class="n">anggen</span> <span class="o">=</span> <span class="n">angle_generator</span><span class="p">()</span><span class="o">.</span><span class="n">landsat</span><span class="p">(</span><span class="n">l2h</span><span class="p">)</span>
        <span class="k">elif</span> <span class="s1">&#39;LANDSAT&#39;</span> <span class="ow">in</span> <span class="n">sensor</span><span class="p">:</span>
            <span class="n">angle_generator</span><span class="p">()</span><span class="o">.</span><span class="n">landsat_tm</span><span class="p">(</span><span class="n">l2h</span><span class="p">)</span>
        <span class="c1"># stop process for landsat angle computation only</span>
        <span class="k">if</span> <span class="n">angleonly</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="c1">##################################</span>
        <span class="c1"># RESAMPLE TO A UNIQUE RESOLUTION</span>
        <span class="c1">##################################</span>
        <span class="k">if</span> <span class="s1">&#39;S2&#39;</span> <span class="ow">in</span> <span class="n">sensor</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">memory_safe</span><span class="p">:</span>
                <span class="n">l2h</span><span class="o">.</span><span class="n">product</span> <span class="o">=</span> <span class="n">_utils</span><span class="o">.</span><span class="n">generic_resampler</span><span class="p">(</span><span class="n">l2h</span><span class="o">.</span><span class="n">product</span><span class="p">,</span> <span class="n">resolution</span><span class="o">=</span><span class="n">resolution</span><span class="p">)</span>  <span class="c1"># , method=&#39;Nearest&#39;)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">l2h</span><span class="o">.</span><span class="n">product</span> <span class="o">=</span> <span class="n">_utils</span><span class="o">.</span><span class="n">s2_resampler</span><span class="p">(</span><span class="n">l2h</span><span class="o">.</span><span class="n">product</span><span class="p">,</span> <span class="n">resolution</span><span class="o">=</span><span class="n">resolution</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">l2h</span><span class="o">.</span><span class="n">product</span> <span class="o">=</span> <span class="n">_utils</span><span class="o">.</span><span class="n">resampler</span><span class="p">(</span><span class="n">l2h</span><span class="o">.</span><span class="n">product</span><span class="p">,</span> <span class="n">resolution</span><span class="o">=</span><span class="n">resolution</span><span class="p">)</span>  <span class="c1"># , upmethod=&#39;Nearest&#39;)</span>

        <span class="c1">##################################</span>
        <span class="c1"># SUBSET TO AREA OF INTEREST</span>
        <span class="c1">##################################</span>
        <span class="n">l2h</span><span class="o">.</span><span class="n">product</span> <span class="o">=</span> <span class="n">_utils</span><span class="o">.</span><span class="n">get_subset</span><span class="p">(</span><span class="n">l2h</span><span class="o">.</span><span class="n">product</span><span class="p">,</span> <span class="n">wkt</span><span class="p">)</span>
        <span class="n">l2h</span><span class="o">.</span><span class="n">get_product_info</span><span class="p">()</span>
        <span class="n">l2h</span><span class="o">.</span><span class="n">set_outfile</span><span class="p">(</span><span class="n">outfile</span><span class="p">)</span>
        <span class="n">l2h</span><span class="o">.</span><span class="n">wkt</span> <span class="o">=</span> <span class="n">_utils</span><span class="o">.</span><span class="n">get_extent</span><span class="p">(</span><span class="n">l2h</span><span class="o">.</span><span class="n">product</span><span class="p">)</span>
        <span class="n">l2h</span><span class="o">.</span><span class="n">crs</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">l2h</span><span class="o">.</span><span class="n">product</span><span class="o">.</span><span class="n">getBand</span><span class="p">(</span><span class="n">l2h</span><span class="o">.</span><span class="n">band_names</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">getGeoCoding</span><span class="p">()</span><span class="o">.</span><span class="n">getImageCRS</span><span class="p">())</span>

        <span class="c1">##################################</span>
        <span class="c1">## ADD ELEVATION BAND</span>
        <span class="c1">##################################</span>
        <span class="k">if</span> <span class="n">dem</span><span class="p">:</span>
            <span class="n">l2h</span><span class="o">.</span><span class="n">get_elevation</span><span class="p">()</span>

        <span class="c1">##################################</span>
        <span class="c1"># GET IMAGE AND RASTER PROPERTIES</span>
        <span class="c1">##################################</span>
        <span class="n">l2h</span><span class="o">.</span><span class="n">get_bands</span><span class="p">(</span><span class="n">l2h</span><span class="o">.</span><span class="n">band_names</span><span class="p">)</span>
        <span class="n">l2h</span><span class="o">.</span><span class="n">print_info</span><span class="p">()</span>

        <span class="c1">##################################</span>
        <span class="c1"># SET NEW BAND FOR MASKING</span>
        <span class="c1">##################################</span>
        <span class="n">l2h</span><span class="o">.</span><span class="n">product</span><span class="o">.</span><span class="n">addBand</span><span class="p">(</span><span class="s1">&#39;ndwi&#39;</span><span class="p">,</span> <span class="n">ProductData</span><span class="o">.</span><span class="n">TYPE_FLOAT32</span><span class="p">)</span>
        <span class="n">l2h</span><span class="o">.</span><span class="n">ndwi_band</span> <span class="o">=</span> <span class="n">l2h</span><span class="o">.</span><span class="n">product</span><span class="o">.</span><span class="n">getBand</span><span class="p">(</span><span class="s1">&#39;ndwi&#39;</span><span class="p">)</span>
        <span class="n">l2h</span><span class="o">.</span><span class="n">ndwi_band</span><span class="o">.</span><span class="n">ensureRasterData</span><span class="p">()</span>
        <span class="n">l2h</span><span class="o">.</span><span class="n">ndwi_band</span><span class="o">.</span><span class="n">loadRasterData</span><span class="p">()</span>

        <span class="c1">##################################</span>
        <span class="c1"># GET ANCILLARY DATA (Pressure, O3, water vapor, NO2...</span>
        <span class="c1">##################################</span>
        <span class="n">l2h</span><span class="o">.</span><span class="n">aux</span> <span class="o">=</span> <span class="n">auxdata</span><span class="o">.</span><span class="n">cams</span><span class="p">()</span>

        <span class="n">target</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">l2h</span><span class="o">.</span><span class="n">cams_folder</span><span class="p">,</span> <span class="n">l2h</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;_month_&#39;</span> <span class="o">+</span> <span class="n">l2h</span><span class="o">.</span><span class="n">ancillary</span> <span class="o">+</span> <span class="s1">&#39;.nc&#39;</span><span class="p">))</span>
        <span class="n">l2h</span><span class="o">.</span><span class="n">aux</span><span class="o">.</span><span class="n">load_cams_data</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">l2h</span><span class="o">.</span><span class="n">date</span><span class="p">,</span> <span class="n">data_type</span><span class="o">=</span><span class="n">l2h</span><span class="o">.</span><span class="n">ancillary</span><span class="p">)</span>
        <span class="n">l2h</span><span class="o">.</span><span class="n">aux</span><span class="o">.</span><span class="n">get_cams_ancillary</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">l2h</span><span class="o">.</span><span class="n">date</span><span class="p">,</span> <span class="n">l2h</span><span class="o">.</span><span class="n">wkt</span><span class="p">)</span>

        <span class="c1">## uncomment this part to use ecmwf files provided in the .SAFE format</span>
        <span class="c1"># if &#39;S2&#39; in sensor:</span>
        <span class="c1">#     l2h.aux.get_tile_dir(file)</span>
        <span class="c1">#     l2h.aux.get_aux_dir()</span>
        <span class="c1">#     l2h.aux.get_ecmwf_data()</span>

        <span class="c1"># get pressure at the scene altitude</span>
        <span class="n">l2h</span><span class="o">.</span><span class="n">pressure_msl</span> <span class="o">=</span> <span class="n">l2h</span><span class="o">.</span><span class="n">aux</span><span class="o">.</span><span class="n">msl</span>  <span class="c1"># acutils.misc.get_pressure(altitude, l2h.aux.msl)</span>
        <span class="k">if</span> <span class="n">dem</span><span class="p">:</span>
            <span class="n">altitude</span> <span class="o">=</span> <span class="n">l2h</span><span class="o">.</span><span class="n">elevation</span>
        <span class="n">l2h</span><span class="o">.</span><span class="n">pressure</span> <span class="o">=</span> <span class="n">acutils</span><span class="o">.</span><span class="n">misc</span><span class="o">.</span><span class="n">get_pressure</span><span class="p">(</span><span class="n">altitude</span><span class="p">,</span> <span class="n">l2h</span><span class="o">.</span><span class="n">pressure_msl</span><span class="p">)</span>  <span class="c1"># l2h.aux.pressure = l2h.pressure</span>

        <span class="c1">##################################</span>
        <span class="c1"># GET ANCILLARY DATA (AEROSOL)</span>
        <span class="c1">##################################</span>
        <span class="n">aero</span> <span class="o">=</span> <span class="n">acutils</span><span class="o">.</span><span class="n">aerosol</span><span class="p">()</span>

        <span class="c1"># AERONET data</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">l2h</span><span class="o">.</span><span class="n">aerosol</span> <span class="o">==</span> <span class="s1">&#39;aeronet&#39;</span><span class="p">):</span>
            <span class="n">l2h</span><span class="o">.</span><span class="n">set_aeronetfile</span><span class="p">(</span><span class="n">aeronet_file</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">l2h</span><span class="o">.</span><span class="n">aux</span><span class="o">.</span><span class="n">Aeronet</span><span class="o">.</span><span class="n">import_aeronet_data</span><span class="p">(</span><span class="n">aero</span><span class="p">,</span> <span class="n">l2h</span><span class="o">.</span><span class="n">aeronetfile</span><span class="p">,</span> <span class="n">l2h</span><span class="o">.</span><span class="n">date</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Error: No aeronet data in the +/- 2day time window.&#39;</span><span class="p">)</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>

            <span class="n">l2h</span><span class="o">.</span><span class="n">aux</span><span class="o">.</span><span class="n">aot_wl</span> <span class="o">=</span> <span class="n">aero</span><span class="o">.</span><span class="n">wavelengths</span>
            <span class="n">l2h</span><span class="o">.</span><span class="n">aux</span><span class="o">.</span><span class="n">aot</span> <span class="o">=</span> <span class="n">aero</span><span class="o">.</span><span class="n">aot</span>
            <span class="n">l2h</span><span class="o">.</span><span class="n">aux</span><span class="o">.</span><span class="n">aot550</span> <span class="o">=</span> <span class="n">aero</span><span class="o">.</span><span class="n">aot550</span>

        <span class="c1"># CAMS (ECMWF)</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">l2h</span><span class="o">.</span><span class="n">aerosol</span> <span class="o">==</span> <span class="s1">&#39;cams_forecast&#39;</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">l2h</span><span class="o">.</span><span class="n">aerosol</span> <span class="o">==</span> <span class="s1">&#39;cams_reanalysis&#39;</span><span class="p">):</span>
            <span class="c1"># daily file</span>
            <span class="c1"># target=Path(os.path.join(l2h.ecmwf_root,l2h.date.strftime(&#39;%Y-%m-%d&#39;)+&#39;_cams_aero.nc&#39;))</span>
            <span class="c1"># cams=aux.get_cams_aerosol(target,l2h.date.strftime(&#39;%Y-%m-%d&#39;),l2h.wkt,l2h.crs)</span>
            <span class="c1"># monthly file</span>
            <span class="n">target</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">l2h</span><span class="o">.</span><span class="n">cams_folder</span><span class="p">,</span> <span class="n">l2h</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;_month_&#39;</span> <span class="o">+</span>
                                       <span class="n">l2h</span><span class="o">.</span><span class="n">aerosol</span> <span class="o">+</span> <span class="s1">&#39;.nc&#39;</span><span class="p">))</span>
            <span class="n">l2h</span><span class="o">.</span><span class="n">aux</span><span class="o">.</span><span class="n">get_cams_aerosol</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">l2h</span><span class="o">.</span><span class="n">date</span><span class="p">,</span> <span class="n">l2h</span><span class="o">.</span><span class="n">wkt</span><span class="p">)</span>

        <span class="k">elif</span> <span class="p">(</span><span class="n">l2h</span><span class="o">.</span><span class="n">aerosol</span> <span class="o">==</span> <span class="s1">&#39;user_model&#39;</span><span class="p">):</span>
            <span class="n">l2h</span><span class="o">.</span><span class="n">aux</span><span class="o">.</span><span class="n">aot550</span> <span class="o">=</span> <span class="n">aot550</span>
            <span class="n">l2h</span><span class="o">.</span><span class="n">angstrom</span> <span class="o">=</span> <span class="n">angstrom</span>
            <span class="n">l2h</span><span class="o">.</span><span class="n">aux</span><span class="o">.</span><span class="n">aot</span> <span class="o">=</span> <span class="n">l2h</span><span class="o">.</span><span class="n">aux</span><span class="o">.</span><span class="n">aot550</span> <span class="o">*</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">l2h</span><span class="o">.</span><span class="n">wl</span><span class="p">)</span> <span class="o">/</span> <span class="mi">550</span><span class="p">)</span> <span class="o">**</span> <span class="p">(</span><span class="o">-</span><span class="n">l2h</span><span class="o">.</span><span class="n">angstrom</span><span class="p">)</span>
            <span class="n">l2h</span><span class="o">.</span><span class="n">aux</span><span class="o">.</span><span class="n">aot_wl</span> <span class="o">=</span> <span class="n">l2h</span><span class="o">.</span><span class="n">wl</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s2">&quot;No aerosol data provided, try again.&quot;</span><span class="p">)</span>

        <span class="c1"># set spectral aot for satellie bands</span>
        <span class="n">aero</span><span class="o">.</span><span class="n">fit_spectral_aot</span><span class="p">(</span><span class="n">l2h</span><span class="o">.</span><span class="n">aux</span><span class="o">.</span><span class="n">aot_wl</span><span class="p">,</span> <span class="n">l2h</span><span class="o">.</span><span class="n">aux</span><span class="o">.</span><span class="n">aot</span><span class="p">)</span>
        <span class="n">l2h</span><span class="o">.</span><span class="n">aot</span> <span class="o">=</span> <span class="n">aero</span><span class="o">.</span><span class="n">get_spectral_aot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">l2h</span><span class="o">.</span><span class="n">wl</span><span class="p">))</span>
        <span class="n">l2h</span><span class="o">.</span><span class="n">aot550</span> <span class="o">=</span> <span class="n">l2h</span><span class="o">.</span><span class="n">aux</span><span class="o">.</span><span class="n">aot550</span>

        <span class="c1">#####################################</span>
        <span class="c1"># LOAD LUT FOR ATMOSPHERIC CORRECTION</span>
        <span class="c1">#####################################</span>
        <span class="c1"># load lut</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;loading lut...&#39;</span><span class="p">,</span> <span class="n">l2h</span><span class="o">.</span><span class="n">lutfine</span><span class="p">)</span>
        <span class="n">lutf</span> <span class="o">=</span> <span class="n">acutils</span><span class="o">.</span><span class="n">lut</span><span class="p">(</span><span class="n">l2h</span><span class="o">.</span><span class="n">band_names</span><span class="p">)</span>
        <span class="n">lutc</span> <span class="o">=</span> <span class="n">acutils</span><span class="o">.</span><span class="n">lut</span><span class="p">(</span><span class="n">l2h</span><span class="o">.</span><span class="n">band_names</span><span class="p">)</span>
        <span class="n">lutf</span><span class="o">.</span><span class="n">load_lut</span><span class="p">(</span><span class="n">l2h</span><span class="o">.</span><span class="n">lutfine</span><span class="p">,</span> <span class="n">indband</span><span class="p">)</span>
        <span class="n">lutc</span><span class="o">.</span><span class="n">load_lut</span><span class="p">(</span><span class="n">l2h</span><span class="o">.</span><span class="n">lutcoarse</span><span class="p">,</span> <span class="n">indband</span><span class="p">)</span>

        <span class="c1"># normalization of Cext to get spectral dependence of fine and coarse modes</span>
        <span class="n">nCext_f</span> <span class="o">=</span> <span class="n">lutf</span><span class="o">.</span><span class="n">Cext</span> <span class="o">/</span> <span class="n">lutf</span><span class="o">.</span><span class="n">Cext550</span>
        <span class="n">nCext_c</span> <span class="o">=</span> <span class="n">lutc</span><span class="o">.</span><span class="n">Cext</span> <span class="o">/</span> <span class="n">lutc</span><span class="o">.</span><span class="n">Cext550</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;param aerosol&#39;</span><span class="p">,</span> <span class="n">nCext_f</span><span class="p">,</span> <span class="n">nCext_c</span><span class="p">,</span> <span class="n">l2h</span><span class="o">.</span><span class="n">aot</span><span class="p">)</span>
        <span class="n">aero</span><span class="o">.</span><span class="n">fit_aero</span><span class="p">(</span><span class="n">nCext_f</span><span class="p">,</span> <span class="n">nCext_c</span><span class="p">,</span> <span class="n">l2h</span><span class="o">.</span><span class="n">aot</span> <span class="o">/</span> <span class="n">l2h</span><span class="o">.</span><span class="n">aot550</span><span class="p">)</span>
        <span class="n">l2h</span><span class="o">.</span><span class="n">fcoef</span> <span class="o">=</span> <span class="n">aero</span><span class="o">.</span><span class="n">fcoef</span>
        <span class="c1"># rlut = [x + y for x, y in zip([fcoef * x for x in rlut_f], [(1. - fcoef) * x for x in rlut_c])]</span>

        <span class="c1"># acutils.plot_lut(grid_lut[3], grid_lut[2], rlut_c[9][2, 13, :, :])</span>
        <span class="c1"># acutils.plot_lut(grid_lut[3], grid_lut[2], rlut_f[9][2, 13, :, :])</span>
        <span class="c1"># acutils.plot_lut(grid_lut[3], grid_lut[2], rlut[9][2, 13, :, :])</span>

        <span class="c1"># correction for pressure</span>
        <span class="c1"># scaling of the lut values and rayleigh optical thickness</span>
        <span class="c1"># rlut_f = [x * l2h.pressure / l2h.pressure_ref for x in lutf.refl]</span>
        <span class="c1"># rlut_c = [x * l2h.pressure / l2h.pressure_ref for x in lutc.refl]</span>
        <span class="c1"># l2h.rot = [x * l2h.pressure / l2h.pressure_ref for x in l2h.sensordata.rot]</span>
        <span class="n">l2h</span><span class="o">.</span><span class="n">rot</span> <span class="o">=</span> <span class="n">l2h</span><span class="o">.</span><span class="n">sensordata</span><span class="o">.</span><span class="n">rot</span>

        <span class="c1">####################################</span>
        <span class="c1">#     Set SMAC patrameters for</span>
        <span class="c1">#    absorbing gases correction</span>
        <span class="c1">####################################</span>
        <span class="n">smac</span> <span class="o">=</span> <span class="n">acutils</span><span class="o">.</span><span class="n">smac</span><span class="p">(</span><span class="n">l2h</span><span class="o">.</span><span class="n">sensordata</span><span class="o">.</span><span class="n">smac_bands</span><span class="p">,</span> <span class="n">l2h</span><span class="o">.</span><span class="n">sensordata</span><span class="o">.</span><span class="n">smac_dir</span><span class="p">)</span>
        <span class="n">smac</span><span class="o">.</span><span class="n">set_gas_param</span><span class="p">()</span>
        <span class="n">smac</span><span class="o">.</span><span class="n">set_values</span><span class="p">(</span><span class="n">o3du</span><span class="o">=</span><span class="n">l2h</span><span class="o">.</span><span class="n">aux</span><span class="o">.</span><span class="n">o3du</span><span class="p">,</span> <span class="n">h2o</span><span class="o">=</span><span class="n">l2h</span><span class="o">.</span><span class="n">aux</span><span class="o">.</span><span class="n">h2o</span><span class="p">)</span>
        <span class="n">smac</span><span class="o">.</span><span class="n">set_standard_values</span><span class="p">(</span><span class="n">l2h</span><span class="o">.</span><span class="n">pressure_msl</span><span class="p">)</span>
        <span class="n">l2h</span><span class="o">.</span><span class="n">aux</span><span class="o">.</span><span class="n">no2</span> <span class="o">=</span> <span class="n">smac</span><span class="o">.</span><span class="n">uno2</span>

        <span class="c1">######################################</span>
        <span class="c1">#      Create output l2 product</span>
        <span class="c1">#          &#39;l2_product&#39;</span>
        <span class="c1">######################################</span>
        <span class="n">l2h</span><span class="o">.</span><span class="n">create_product</span><span class="p">()</span>
        <span class="c1"># reshaping for fortran binding</span>
        <span class="n">aotlut</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">lutf</span><span class="o">.</span><span class="n">aot</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">l2h</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="s1">&#39;F&#39;</span><span class="p">)</span>
        <span class="n">vzalut</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">lutf</span><span class="o">.</span><span class="n">vza</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">l2h</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="s1">&#39;F&#39;</span><span class="p">)</span>
        <span class="n">szalut</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">lutf</span><span class="o">.</span><span class="n">sza</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">l2h</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="s1">&#39;F&#39;</span><span class="p">)</span>
        <span class="n">razilut</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">lutf</span><span class="o">.</span><span class="n">azi</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">l2h</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="s1">&#39;F&#39;</span><span class="p">)</span>
        <span class="n">rlut_f</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">lutf</span><span class="o">.</span><span class="n">refl</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">l2h</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="s1">&#39;F&#39;</span><span class="p">)</span>
        <span class="n">rlut_c</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">lutc</span><span class="o">.</span><span class="n">refl</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">l2h</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="s1">&#39;F&#39;</span><span class="p">)</span>
        <span class="n">grid_lut</span> <span class="o">=</span> <span class="p">(</span><span class="n">szalut</span><span class="p">,</span> <span class="n">razilut</span><span class="p">,</span> <span class="n">vzalut</span><span class="p">)</span>

        <span class="c1">######################################</span>
        <span class="c1">#      MAIN LOOP</span>
        <span class="c1">######################################</span>
        <span class="c1"># arrays allocation</span>
        <span class="n">aot550guess</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">l2h</span><span class="o">.</span><span class="n">width</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">l2h</span><span class="o">.</span><span class="n">type</span><span class="p">)</span>
        <span class="n">rtoaf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">lutf</span><span class="o">.</span><span class="n">aot</span><span class="o">.</span><span class="fm">__len__</span><span class="p">(),</span> <span class="n">l2h</span><span class="o">.</span><span class="n">N</span><span class="p">,</span> <span class="n">l2h</span><span class="o">.</span><span class="n">width</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">l2h</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="s1">&#39;F&#39;</span><span class="p">)</span>
        <span class="n">rtoac</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">lutc</span><span class="o">.</span><span class="n">aot</span><span class="o">.</span><span class="fm">__len__</span><span class="p">(),</span> <span class="n">l2h</span><span class="o">.</span><span class="n">N</span><span class="p">,</span> <span class="n">l2h</span><span class="o">.</span><span class="n">width</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">l2h</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="s1">&#39;F&#39;</span><span class="p">)</span>
        <span class="n">elev</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">l2h</span><span class="o">.</span><span class="n">width</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">l2h</span><span class="o">.</span><span class="n">type</span><span class="p">)</span>

        <span class="c1"># set aot by hand</span>
        <span class="n">aot550guess</span><span class="o">.</span><span class="n">fill</span><span class="p">(</span><span class="n">l2h</span><span class="o">.</span><span class="n">aot550</span><span class="p">)</span>

        <span class="n">l2h</span><span class="o">.</span><span class="n">load_data</span><span class="p">()</span>
        <span class="n">l2h</span><span class="o">.</span><span class="n">load_flags</span><span class="p">()</span>

        <span class="n">validx</span> <span class="o">=</span> <span class="p">(</span><span class="n">l2h</span><span class="o">.</span><span class="n">mask</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
        <span class="c1"># l2h.sza[~validx]=np.nan</span>
        <span class="c1"># l2h.razi[~validx]=np.nan</span>
        <span class="n">w</span><span class="p">,</span> <span class="n">h</span> <span class="o">=</span> <span class="n">l2h</span><span class="o">.</span><span class="n">width</span><span class="p">,</span> <span class="n">l2h</span><span class="o">.</span><span class="n">height</span>

        <span class="n">l2h</span><span class="o">.</span><span class="n">l2_product</span><span class="o">.</span><span class="n">getBand</span><span class="p">(</span><span class="s1">&#39;SZA&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">writePixels</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">l2h</span><span class="o">.</span><span class="n">sza</span><span class="p">)</span>
        <span class="n">l2h</span><span class="o">.</span><span class="n">l2_product</span><span class="o">.</span><span class="n">getBand</span><span class="p">(</span><span class="s1">&#39;VZA&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">writePixels</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">l2h</span><span class="o">.</span><span class="n">vza</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
        <span class="n">l2h</span><span class="o">.</span><span class="n">l2_product</span><span class="o">.</span><span class="n">getBand</span><span class="p">(</span><span class="s1">&#39;AZI&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">writePixels</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">l2h</span><span class="o">.</span><span class="n">razi</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
        <span class="k">if</span> <span class="n">dem</span><span class="p">:</span>
            <span class="c1"># add elevation band</span>
            <span class="n">l2h</span><span class="o">.</span><span class="n">l2_product</span><span class="o">.</span><span class="n">getBand</span><span class="p">(</span><span class="s1">&#39;elevation&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">writePixels</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">l2h</span><span class="o">.</span><span class="n">elevation</span><span class="p">)</span>

        <span class="c1"># set flags</span>
        <span class="c1"># l2h.flags = l2h.flags + \</span>
        <span class="c1">#             ((l2h.mask == 1) +</span>
        <span class="c1">#              ((l2h.mask == 2) &lt;&lt; 2)</span>
        <span class="c1">#              )</span>
        <span class="c1"># l2h.l2_product.getBand(&#39;flags&#39;).writePixels(0, 0,w,h, np.array(l2h.flags, dtype=np.uint32,order=&#39;F&#39;).T)</span>
        <span class="c1"># l2h.l2_product.getBand(&#39;flags&#39;).writePixels(0, 0,w,h, l2h.flags.astype(np.uint32))</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">startrow</span><span class="p">,</span> <span class="n">l2h</span><span class="o">.</span><span class="n">height</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;process row &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>

            <span class="n">sza</span> <span class="o">=</span> <span class="n">l2h</span><span class="o">.</span><span class="n">sza</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">razi</span> <span class="o">=</span> <span class="n">l2h</span><span class="o">.</span><span class="n">razi</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span>
            <span class="n">vza</span> <span class="o">=</span> <span class="n">l2h</span><span class="o">.</span><span class="n">vza</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span>
            <span class="n">muv</span> <span class="o">=</span> <span class="n">l2h</span><span class="o">.</span><span class="n">muv</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span>
            <span class="n">mu0</span> <span class="o">=</span> <span class="n">l2h</span><span class="o">.</span><span class="n">mu0</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">l2h</span><span class="o">.</span><span class="n">mask</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">flags</span> <span class="o">=</span> <span class="n">l2h</span><span class="o">.</span><span class="n">flags</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">band_rad</span> <span class="o">=</span> <span class="n">l2h</span><span class="o">.</span><span class="n">band_rad</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">dem</span><span class="p">:</span>
                <span class="n">elev</span> <span class="o">=</span> <span class="n">l2h</span><span class="o">.</span><span class="n">elevation</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">pressure</span> <span class="o">=</span> <span class="n">acutils</span><span class="o">.</span><span class="n">misc</span><span class="o">.</span><span class="n">get_pressure</span><span class="p">(</span><span class="n">elev</span><span class="p">,</span> <span class="n">l2h</span><span class="o">.</span><span class="n">pressure_msl</span><span class="p">)</span>
                <span class="n">pressure_corr</span> <span class="o">=</span> <span class="n">pressure</span> <span class="o">/</span> <span class="n">l2h</span><span class="o">.</span><span class="n">pressure_ref</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">pressure_corr</span> <span class="o">=</span> <span class="p">[</span><span class="n">l2h</span><span class="o">.</span><span class="n">pressure</span> <span class="o">/</span> <span class="n">l2h</span><span class="o">.</span><span class="n">pressure_ref</span><span class="p">]</span> <span class="o">*</span> <span class="n">l2h</span><span class="o">.</span><span class="n">width</span>
            <span class="n">pressure_corr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">pressure_corr</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">l2h</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="s1">&#39;F&#39;</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">iband</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">l2h</span><span class="o">.</span><span class="n">N</span><span class="p">):</span>
                <span class="c1"># preparing lut data</span>
                <span class="n">grid_pix</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">sza</span><span class="p">,</span> <span class="n">razi</span><span class="p">[</span><span class="n">iband</span><span class="p">],</span> <span class="n">vza</span><span class="p">[</span><span class="n">iband</span><span class="p">]))</span>

                <span class="k">for</span> <span class="n">iaot</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">aotlut</span><span class="o">.</span><span class="fm">__len__</span><span class="p">()):</span>
                    <span class="n">rtoaf</span><span class="p">[</span><span class="n">iaot</span><span class="p">,</span> <span class="n">iband</span><span class="p">]</span> <span class="o">=</span> <span class="n">lutf</span><span class="o">.</span><span class="n">interp_lut</span><span class="p">(</span><span class="n">grid_lut</span><span class="p">,</span> <span class="n">rlut_f</span><span class="p">[</span><span class="n">iband</span><span class="p">][</span><span class="n">iaot</span><span class="p">,</span> <span class="o">...</span><span class="p">],</span> <span class="n">grid_pix</span><span class="p">)</span>
                    <span class="n">rtoac</span><span class="p">[</span><span class="n">iaot</span><span class="p">,</span> <span class="n">iband</span><span class="p">]</span> <span class="o">=</span> <span class="n">lutc</span><span class="o">.</span><span class="n">interp_lut</span><span class="p">(</span><span class="n">grid_lut</span><span class="p">,</span> <span class="n">rlut_c</span><span class="p">[</span><span class="n">iband</span><span class="p">][</span><span class="n">iaot</span><span class="p">,</span> <span class="o">...</span><span class="p">],</span> <span class="n">grid_pix</span><span class="p">)</span>

                <span class="c1"># correct for gaseous absorption</span>
                <span class="n">tg</span> <span class="o">=</span> <span class="n">smac</span><span class="o">.</span><span class="n">compute_gas_trans</span><span class="p">(</span><span class="n">iband</span><span class="p">,</span> <span class="n">l2h</span><span class="o">.</span><span class="n">pressure_msl</span><span class="p">,</span> <span class="n">mu0</span><span class="p">,</span> <span class="n">muv</span><span class="p">[</span><span class="n">iband</span><span class="p">])</span>
                <span class="n">band_rad</span><span class="p">[</span><span class="n">iband</span><span class="p">]</span> <span class="o">=</span> <span class="n">band_rad</span><span class="p">[</span><span class="n">iband</span><span class="p">]</span> <span class="o">/</span> <span class="n">tg</span>

            <span class="k">if</span> <span class="n">grs_a</span><span class="p">:</span>
                <span class="n">rcorr</span><span class="p">,</span> <span class="n">rcorrg</span><span class="p">,</span> <span class="n">aot550pix</span><span class="p">,</span> <span class="n">brdfpix</span> <span class="o">=</span> <span class="n">grs_a_solver</span><span class="o">.</span><span class="n">main_algo</span><span class="p">(</span><span class="n">l2h</span><span class="o">.</span><span class="n">width</span><span class="p">,</span> <span class="n">l2h</span><span class="o">.</span><span class="n">N</span><span class="p">,</span> <span class="n">aotlut</span><span class="o">.</span><span class="fm">__len__</span><span class="p">(),</span>
                                                                           <span class="n">vza</span><span class="p">,</span> <span class="n">sza</span><span class="p">,</span> <span class="n">razi</span><span class="p">,</span> <span class="n">band_rad</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">l2h</span><span class="o">.</span><span class="n">wl</span><span class="p">,</span>
                                                                           <span class="n">pressure_corr</span><span class="p">,</span> <span class="n">aotlut</span><span class="p">,</span> <span class="n">rtoaf</span><span class="p">,</span> <span class="n">rtoac</span><span class="p">,</span>
                                                                           <span class="n">lutf</span><span class="o">.</span><span class="n">Cext</span><span class="p">,</span> <span class="n">lutc</span><span class="o">.</span><span class="n">Cext</span><span class="p">,</span> <span class="n">lutf</span><span class="o">.</span><span class="n">Cext550</span><span class="p">,</span>
                                                                           <span class="n">lutc</span><span class="o">.</span><span class="n">Cext550</span><span class="p">,</span>
                                                                           <span class="n">l2h</span><span class="o">.</span><span class="n">sensordata</span><span class="o">.</span><span class="n">rg</span><span class="p">,</span> <span class="n">l2h</span><span class="o">.</span><span class="n">solar_irr</span><span class="p">,</span> <span class="n">l2h</span><span class="o">.</span><span class="n">rot</span><span class="p">,</span>
                                                                           <span class="n">l2h</span><span class="o">.</span><span class="n">aot</span><span class="p">,</span>
                                                                           <span class="n">aot550guess</span><span class="p">,</span> <span class="n">l2h</span><span class="o">.</span><span class="n">nodata</span><span class="p">,</span> <span class="n">l2h</span><span class="o">.</span><span class="n">rrs</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">rcorr</span><span class="p">,</span> <span class="n">rcorrg</span><span class="p">,</span> <span class="n">aot550pix</span><span class="p">,</span> <span class="n">brdfpix</span> <span class="o">=</span> <span class="n">grs_solver</span><span class="o">.</span><span class="n">main_algo</span><span class="p">(</span><span class="n">l2h</span><span class="o">.</span><span class="n">width</span><span class="p">,</span> <span class="n">l2h</span><span class="o">.</span><span class="n">N</span><span class="p">,</span> <span class="n">aotlut</span><span class="o">.</span><span class="fm">__len__</span><span class="p">(),</span>
                                                                         <span class="n">vza</span><span class="p">,</span> <span class="n">sza</span><span class="p">,</span> <span class="n">razi</span><span class="p">,</span> <span class="n">band_rad</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">l2h</span><span class="o">.</span><span class="n">wl</span><span class="p">,</span>
                                                                         <span class="n">pressure_corr</span><span class="p">,</span> <span class="n">aotlut</span><span class="p">,</span> <span class="n">rtoaf</span><span class="p">,</span> <span class="n">rtoac</span><span class="p">,</span> <span class="n">lutf</span><span class="o">.</span><span class="n">Cext</span><span class="p">,</span>
                                                                         <span class="n">lutc</span><span class="o">.</span><span class="n">Cext</span><span class="p">,</span>
                                                                         <span class="n">l2h</span><span class="o">.</span><span class="n">sensordata</span><span class="o">.</span><span class="n">rg</span><span class="p">,</span> <span class="n">l2h</span><span class="o">.</span><span class="n">solar_irr</span><span class="p">,</span> <span class="n">l2h</span><span class="o">.</span><span class="n">rot</span><span class="p">,</span>
                                                                         <span class="n">l2h</span><span class="o">.</span><span class="n">aot</span><span class="p">,</span> <span class="n">aot550guess</span><span class="p">,</span> <span class="n">l2h</span><span class="o">.</span><span class="n">fcoef</span><span class="p">,</span> <span class="n">l2h</span><span class="o">.</span><span class="n">nodata</span><span class="p">,</span>
                                                                         <span class="n">l2h</span><span class="o">.</span><span class="n">rrs</span><span class="p">)</span>

            <span class="c1"># reshape for snap modules</span>
            <span class="n">rcorr</span><span class="p">[</span><span class="n">rcorr</span> <span class="o">==</span> <span class="n">l2h</span><span class="o">.</span><span class="n">nodata</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
            <span class="n">rcorrg</span><span class="p">[</span><span class="n">rcorrg</span> <span class="o">==</span> <span class="n">l2h</span><span class="o">.</span><span class="n">nodata</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
            <span class="c1"># rcorr = np.ma.array(rcorr.T, mask=rcorr.T == l2h.nodata, fill_value=np.nan)  # .tolist()</span>
            <span class="c1"># rcorrg = np.ma.array(rcorrg.T, mask=rcorrg.T == l2h.nodata, fill_value=np.nan)  # .tolist()</span>

            <span class="n">ndwi_corr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">((</span><span class="n">rcorrg</span><span class="p">[</span><span class="n">l2h</span><span class="o">.</span><span class="n">sensordata</span><span class="o">.</span><span class="n">NDWI_vis</span><span class="p">]</span> <span class="o">-</span> <span class="n">rcorrg</span><span class="p">[</span><span class="n">l2h</span><span class="o">.</span><span class="n">sensordata</span><span class="o">.</span><span class="n">NDWI_nir</span><span class="p">])</span> <span class="o">/</span> \
                                 <span class="p">(</span><span class="n">rcorrg</span><span class="p">[</span><span class="n">l2h</span><span class="o">.</span><span class="n">sensordata</span><span class="o">.</span><span class="n">NDWI_vis</span><span class="p">]</span> <span class="o">+</span> <span class="n">rcorrg</span><span class="p">[</span><span class="n">l2h</span><span class="o">.</span><span class="n">sensordata</span><span class="o">.</span><span class="n">NDWI_nir</span><span class="p">]))</span>
            <span class="c1"># set flags</span>
            <span class="n">flags</span> <span class="o">=</span> <span class="n">flags</span> <span class="o">+</span> \
                    <span class="p">((</span><span class="n">mask</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span>
                     <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">((</span><span class="n">rcorr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mf">0.01</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">rcorr</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mf">0.01</span><span class="p">))</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span>
                     <span class="p">((</span><span class="n">mask</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span>
                     <span class="p">(((</span><span class="n">ndwi_corr</span> <span class="o">&lt;</span> <span class="n">l2h</span><span class="o">.</span><span class="n">sensordata</span><span class="o">.</span><span class="n">NDWI_threshold</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">|</span> <span class="p">(</span>
                             <span class="n">ndwi_corr</span> <span class="o">&gt;</span> <span class="n">l2h</span><span class="o">.</span><span class="n">sensordata</span><span class="o">.</span><span class="n">NDWI_threshold</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">+</span>
                     <span class="p">((</span><span class="n">rcorrg</span><span class="p">[</span><span class="n">l2h</span><span class="o">.</span><span class="n">sensordata</span><span class="o">.</span><span class="n">high_nir</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">&gt;</span> <span class="n">l2h</span><span class="o">.</span><span class="n">sensordata</span><span class="o">.</span><span class="n">high_nir</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span>
                     <span class="p">)</span>

            <span class="k">for</span> <span class="n">iband</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">l2h</span><span class="o">.</span><span class="n">N</span><span class="p">):</span>
                <span class="n">l2h</span><span class="o">.</span><span class="n">l2_product</span><span class="o">.</span><span class="n">getBand</span><span class="p">(</span><span class="n">l2h</span><span class="o">.</span><span class="n">output</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">l2h</span><span class="o">.</span><span class="n">band_names</span><span class="p">[</span><span class="n">iband</span><span class="p">])</span><span class="o">.</span> \
                    <span class="n">writePixels</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">l2h</span><span class="o">.</span><span class="n">width</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">rcorr</span><span class="p">[</span><span class="n">iband</span><span class="p">]))</span>
                <span class="n">l2h</span><span class="o">.</span><span class="n">l2_product</span><span class="o">.</span><span class="n">getBand</span><span class="p">(</span><span class="n">l2h</span><span class="o">.</span><span class="n">output</span> <span class="o">+</span> <span class="s1">&#39;_g_&#39;</span> <span class="o">+</span> <span class="n">l2h</span><span class="o">.</span><span class="n">band_names</span><span class="p">[</span><span class="n">iband</span><span class="p">])</span><span class="o">.</span> \
                    <span class="n">writePixels</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">l2h</span><span class="o">.</span><span class="n">width</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">rcorrg</span><span class="p">[</span><span class="n">iband</span><span class="p">]))</span>

            <span class="n">l2h</span><span class="o">.</span><span class="n">l2_product</span><span class="o">.</span><span class="n">getBand</span><span class="p">(</span><span class="s1">&#39;flags&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">writePixels</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">l2h</span><span class="o">.</span><span class="n">width</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">flags</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint32</span><span class="p">))</span>
            <span class="n">l2h</span><span class="o">.</span><span class="n">l2_product</span><span class="o">.</span><span class="n">getBand</span><span class="p">(</span><span class="s1">&#39;BRDFg&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">writePixels</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">l2h</span><span class="o">.</span><span class="n">width</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">brdfpix</span><span class="p">)</span>
            <span class="n">l2h</span><span class="o">.</span><span class="n">l2_product</span><span class="o">.</span><span class="n">getBand</span><span class="p">(</span><span class="s2">&quot;aot550&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">writePixels</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">l2h</span><span class="o">.</span><span class="n">width</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">aot550pix</span><span class="p">)</span>

            <span class="c1"># TODO improve checksum scheme</span>
            <span class="n">l2h</span><span class="o">.</span><span class="n">checksum</span><span class="p">(</span><span class="s1">&#39;startrow &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>

        <span class="n">l2h</span><span class="o">.</span><span class="n">finalize_product</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">anggen</span><span class="p">:</span>
            <span class="c1"># TODO finalize this part to add angle files to original tar.gz image (e.g., LC8*.tgz)</span>
            <span class="c1"># copy tgz image and add angle files</span>
            <span class="n">landsat_file</span> <span class="o">=</span> <span class="n">file_orig</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.tgz&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">make_archive</span><span class="p">(</span><span class="n">landsat_file</span><span class="p">,</span> <span class="s1">&#39;gztar&#39;</span><span class="p">,</span> <span class="n">tmp_dir</span><span class="p">)</span>
            <span class="c1"># os.rename(landsat_file,landsat_file.replace(&#39;.tar.gz&#39;,&#39;.tgz&#39;))</span>

        <span class="k">if</span> <span class="n">unzip</span><span class="p">:</span>
            <span class="c1"># remove unzipped files (Sentinel files)</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">ignore_errors</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">untar</span><span class="p">:</span>
            <span class="c1"># remove untared files (Landsat files)</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">tmp_dir</span><span class="p">,</span> <span class="n">ignore_errors</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div></div>
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../index.html">grs</a></h1>








<h3>Navigation</h3>
<p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../page.html">Documentation for the GRS algorithm.</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../modules.html">Project Modules</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../fortran_modules.html">Fortran Modules</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../deployment_modules.html">Deployment Modules</a></li>
</ul>


<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2019, Tristan Harmel.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 2.2.1</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
    </div>

    

    
  </body>
</html>